<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Interactive guide for the AI Evals Platform — architecture, workflows, APIs, and code reference."
    />
    <meta name="author" content="AI Tatva" />
    <title>AI Evals Platform — Interactive Guide</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400&display=swap"
      rel="stylesheet"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <!-- D3.js v7 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Prism.js — Tomorrow theme + core -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

    <style>
      /* =========================================================
       DESIGN TOKENS
       ========================================================= */

      :root {
        /* Backgrounds */
        --bg: #f8fafc;
        --bg-secondary: #f1f5f9;
        --surface: #ffffff;
        --surface-hover: #f8fafc;

        /* Text */
        --text: #0f172a;
        --text-secondary: #475569;
        --text-muted: #94a3b8;

        /* Borders */
        --border: #e2e8f0;
        --border-subtle: #f1f5f9;

        /* Accent — Indigo */
        --accent: #6366f1;
        --accent-light: #818cf8;
        --accent-surface: #eef2ff;
        --accent-text: #4338ca;

        /* Semantic */
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;

        /* Code */
        --code-bg: #1e293b;

        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.08);

        /* Glass */
        --glass-bg: rgba(255, 255, 255, 0.72);
        --glass-border: rgba(255, 255, 255, 0.4);
      }

      [data-theme="dark"] {
        --bg: #0f172a;
        --bg-secondary: #1e293b;
        --surface: #1e293b;
        --surface-hover: #263348;

        --text: #f1f5f9;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;

        --border: #334155;
        --border-subtle: #1e293b;

        --accent: #818cf8;
        --accent-light: #a5b4fc;
        --accent-surface: #1e1b4b;
        --accent-text: #c7d2fe;

        --success: #34d399;
        --warning: #fbbf24;
        --error: #f87171;

        --code-bg: #0f172a;

        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.4);

        --glass-bg: rgba(15, 23, 42, 0.72);
        --glass-border: rgba(51, 65, 85, 0.4);
      }

      /* =========================================================
       RESET & BASE
       ========================================================= */

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* =========================================================
       SCROLLBAR
       ========================================================= */

      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--text-muted);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      /* =========================================================
       CONTAINER
       ========================================================= */

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
      }

      /* =========================================================
       HEADER
       ========================================================= */

      .header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        background: var(--glass-bg);
        border-bottom: 1px solid var(--border);
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 2rem;
        transition: background-color 0.3s ease;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .header-logo {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        color: var(--accent);
        flex-shrink: 0;
      }

      .header-logo svg {
        width: 28px;
        height: 28px;
      }

      .header-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -0.01em;
      }

      .header-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.1875rem 0.5rem;
        border-radius: 99px;
        font-size: 0.6875rem;
        font-weight: 600;
        background: var(--accent-surface);
        color: var(--accent-text);
        margin-left: 0.25rem;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* =========================================================
       THEME TOGGLE
       ========================================================= */

      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-secondary);
        cursor: pointer;
        transition:
          background-color 0.2s ease,
          color 0.2s ease,
          border-color 0.2s ease;
      }

      .theme-toggle:hover {
        background: var(--accent-surface);
        color: var(--accent);
        border-color: var(--accent);
      }

      .theme-toggle svg {
        width: 18px;
        height: 18px;
      }

      .theme-toggle .icon-sun {
        display: none;
      }

      .theme-toggle .icon-moon {
        display: block;
      }

      [data-theme="dark"] .theme-toggle .icon-sun {
        display: block;
      }

      [data-theme="dark"] .theme-toggle .icon-moon {
        display: none;
      }

      /* =========================================================
       NAV TABS
       ========================================================= */

      .nav-tabs {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }

      .nav-tabs::-webkit-scrollbar {
        display: none;
      }

      .nav-tab {
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition:
          background-color 0.2s ease,
          color 0.2s ease;
        white-space: nowrap;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-family: inherit;
      }

      .nav-tab:hover {
        background: var(--accent-surface);
        color: var(--accent-text);
      }

      .nav-tab.active {
        background: var(--accent);
        color: #ffffff;
      }

      /* =========================================================
       TAB CONTENT
       ========================================================= */

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeInUp 0.4s ease both;
      }

      /* =========================================================
       CARDS
       ========================================================= */

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .card-body {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .card-title {
        font-size: 1.0625rem;
        font-weight: 700;
        letter-spacing: -0.01em;
        line-height: 1.35;
      }

      .card-text {
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.65;
      }

      .icon-circle {
        width: 3rem;
        height: 3rem;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.25rem;
      }

      .badge-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.25rem;
      }

      .glass-card {
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 1.5rem;
      }

      /* =========================================================
       GRID LAYOUTS
       ========================================================= */

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
      }

      @media (max-width: 768px) {
        .grid-2,
        .grid-3 {
          grid-template-columns: 1fr;
        }
      }

      /* =========================================================
       HERO SECTION
       ========================================================= */

      .hero {
        background: linear-gradient(135deg, #6366f1, #8b5cf6, #a78bfa);
        color: #ffffff;
        padding: 4rem 2rem;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
      }

      .hero::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle at 30% 40%,
          rgba(255, 255, 255, 0.08) 0%,
          transparent 60%
        );
        pointer-events: none;
      }

      .hero h1 {
        font-size: 2.5rem;
        font-weight: 800;
        letter-spacing: -0.025em;
        margin-bottom: 0.75rem;
        position: relative;
      }

      .hero-subtitle {
        font-size: 1.125rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
      }

      /* =========================================================
       SECTION HEADERS
       ========================================================= */

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        letter-spacing: -0.01em;
      }

      .section-subtitle {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
        font-size: 0.9375rem;
        line-height: 1.6;
      }

      .tech-list {
        list-style: disc;
        padding-left: 1.125rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.7;
      }

      .tech-list li + li {
        margin-top: 0.125rem;
      }

      /* =========================================================
       WORKSPACE CARDS
       ========================================================= */

      .workspace-card {
        padding: 2rem;
        border-radius: 16px;
        border: 2px solid var(--border);
        background: var(--surface);
        transition:
          border-color 0.2s ease,
          transform 0.2s ease,
          box-shadow 0.2s ease;
        cursor: default;
      }

      .workspace-card:hover {
        border-color: var(--accent);
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .workspace-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.25rem;
      }

      .workspace-card-title {
        font-size: 1.125rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .workspace-card-desc {
        font-size: 0.875rem;
        color: var(--text-secondary);
        line-height: 1.6;
      }

      /* =========================================================
       STEPPER
       ========================================================= */

      .stepper {
        display: flex;
        gap: 0;
        margin: 2rem 0;
      }

      .step {
        flex: 1;
        text-align: center;
        padding: 1rem;
        position: relative;
      }

      .step-number {
        width: 36px;
        height: 36px;
        border-radius: 9999px;
        background: var(--accent-surface);
        color: var(--accent);
        font-weight: 700;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        position: relative;
        z-index: 1;
      }

      .step::after {
        content: "";
        position: absolute;
        top: calc(1rem + 18px);
        left: calc(50% + 18px);
        width: calc(100% - 36px);
        height: 2px;
        background: var(--border);
      }

      .step:last-child::after {
        display: none;
      }

      .step-content {
        display: flex;
        flex-direction: column;
        gap: 0.1875rem;
        align-items: center;
      }

      .step-title {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--text);
        line-height: 1.35;
      }

      .step-text {
        font-size: 0.75rem;
        color: var(--text-secondary);
        line-height: 1.5;
        max-width: 16rem;
        margin: 0 auto;
      }

      .step-label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--text);
      }

      .step-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }

      /* =========================================================
       ACCORDION
       ========================================================= */

      .accordion {
        margin-bottom: 0.5rem;
        border-radius: 8px;
        overflow: hidden;
      }

      .accordion-toggle {
        cursor: pointer;
        width: 100%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.5rem;
        background: var(--bg-secondary);
        color: var(--text);
        font-weight: 600;
        font-size: 0.9375rem;
        font-family: inherit;
        text-align: left;
        user-select: none;
        transition: background-color 0.2s ease;
      }

      .accordion-toggle:hover {
        background: var(--border);
      }

      .accordion-body {
        max-height: 0;
        overflow: hidden;
        padding: 0 1.5rem;
        transition:
          max-height 0.3s ease,
          padding 0.2s ease;
      }

      .accordion.active .accordion-body {
        max-height: 5000px;
        padding: 1rem 1.5rem 1.25rem;
      }

      .accordion-icon {
        transition: transform 0.3s ease;
        flex-shrink: 0;
        width: 18px;
        height: 18px;
        color: var(--text-muted);
      }

      .accordion.active .accordion-icon {
        transform: rotate(180deg);
      }

      /* =========================================================
       CODE BLOCKS
       ========================================================= */

      pre.code-block {
        background: var(--code-bg);
        color: #e2e8f0;
        padding: 1.25rem;
        border-radius: 8px;
        overflow-x: auto;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8125rem;
        line-height: 1.6;
        position: relative;
        margin: 1rem 0;
      }

      .copy-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #94a3b8;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        font-family: "Inter", sans-serif;
        transition:
          background-color 0.2s ease,
          color 0.2s ease;
      }

      .copy-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #e2e8f0;
      }

      code {
        font-family: "JetBrains Mono", monospace;
      }

      code.language-typescript {
        color: inherit;
      }

      inline code,
      p code,
      li code,
      td code {
        background: var(--bg-secondary);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.8125rem;
        color: var(--accent-text);
      }

      /* =========================================================
       TABLES
       ========================================================= */

      .table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin: 1rem 0;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        background: var(--bg-secondary);
        font-weight: 600;
        font-size: 0.8125rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        white-space: nowrap;
      }

      .data-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border);
        font-size: 0.875rem;
        vertical-align: top;
      }

      .data-table tr:last-child td {
        border-bottom: none;
      }

      .data-table tr:hover td {
        background: var(--surface-hover);
      }

      .info-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }

      .info-table td {
        padding: 0.625rem 0;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }

      .info-table tr:last-child td {
        border-bottom: none;
      }

      .info-label {
        width: 140px;
        color: var(--text-secondary);
        font-weight: 600;
        padding-right: 1rem;
        white-space: nowrap;
      }

      .divider {
        border: none;
        border-top: 1px solid var(--border);
        margin: 1rem 0;
      }

      /* =========================================================
       BADGES / PILLS
       ========================================================= */

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.625rem;
        border-radius: 99px;
        font-size: 0.6875rem;
        font-weight: 600;
        white-space: nowrap;
      }

      .badge-blue {
        background: #dbeafe;
        color: #1d4ed8;
      }

      .badge-green {
        background: #d1fae5;
        color: #059669;
      }

      .badge-purple {
        background: #ede9fe;
        color: #7c3aed;
      }

      .badge-amber {
        background: #fef3c7;
        color: #d97706;
      }

      .badge-red {
        background: #fee2e2;
        color: #dc2626;
      }

      [data-theme="dark"] .badge-blue {
        background: rgba(59, 130, 246, 0.15);
        color: #93bbfd;
      }

      [data-theme="dark"] .badge-green {
        background: rgba(16, 185, 129, 0.15);
        color: #6ee7b7;
      }

      [data-theme="dark"] .badge-purple {
        background: rgba(139, 92, 246, 0.15);
        color: #c4b5fd;
      }

      [data-theme="dark"] .badge-amber {
        background: rgba(245, 158, 11, 0.15);
        color: #fcd34d;
      }

      [data-theme="dark"] .badge-red {
        background: rgba(239, 68, 68, 0.15);
        color: #fca5a5;
      }

      /* =========================================================
       MERMAID DIAGRAMS
       ========================================================= */

      .mermaid {
        margin: 1.5rem 0;
        text-align: center;
      }

      .mermaid svg {
        max-width: 100%;
      }

      /* =========================================================
       D3 BRAIN MAP
       ========================================================= */

      #brain-map-svg {
        width: 100%;
        height: 600px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--surface);
      }

      .node-label {
        font-family: "Inter", sans-serif;
        pointer-events: none;
        fill: var(--text);
        font-size: 11px;
        font-weight: 500;
      }

      .link {
        stroke: var(--border);
        stroke-opacity: 0.6;
        fill: none;
      }

      /* =========================================================
       FILTER PILLS
       ========================================================= */

      .filter-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .filter-pill {
        padding: 0.375rem 0.875rem;
        border-radius: 99px;
        border: 1px solid var(--border);
        background: var(--surface);
        font-size: 0.8125rem;
        cursor: pointer;
        transition:
          background-color 0.2s ease,
          color 0.2s ease,
          border-color 0.2s ease;
        color: var(--text-secondary);
        font-family: inherit;
        font-weight: 500;
      }

      .filter-pill:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .filter-pill.active {
        background: var(--accent);
        color: #ffffff;
        border-color: var(--accent);
      }

      /* =========================================================
       INFO PANEL
       ========================================================= */

      .info-panel {
        min-height: 120px;
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        transition: background-color 0.2s ease;
      }

      .info-panel-title {
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      .info-panel-text {
        font-size: 0.875rem;
        color: var(--text-secondary);
        line-height: 1.6;
      }

      /* =========================================================
       SEARCH INPUT
       ========================================================= */

      .search-wrapper {
        position: relative;
        display: inline-flex;
        align-items: center;
      }

      .search-input {
        width: 100%;
        max-width: 320px;
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--surface);
        color: var(--text);
        font-size: 0.875rem;
        font-family: inherit;
        outline: none;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }

      .search-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-surface);
      }

      .search-input::placeholder {
        color: var(--text-muted);
      }

      .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        width: 16px;
        height: 16px;
        pointer-events: none;
      }

      /* =========================================================
       KEYFRAMES
       ========================================================= */

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(16px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      /* =========================================================
       FOOTER
       ========================================================= */

      .footer {
        margin-top: 4rem;
        padding: 2rem;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.8125rem;
        border-top: 1px solid var(--border);
      }

      /* =========================================================
       UTILITY HELPERS
       ========================================================= */

      .flex {
        display: flex;
      }

      .flex-col {
        flex-direction: column;
      }

      .items-center {
        align-items: center;
      }

      .justify-between {
        justify-content: space-between;
      }

      .gap-1 {
        gap: 0.5rem;
      }

      .gap-2 {
        gap: 1rem;
      }

      .mt-1 {
        margin-top: 0.5rem;
      }

      .mt-2 {
        margin-top: 1rem;
      }

      .mt-3 {
        margin-top: 1.5rem;
      }

      .mb-1 {
        margin-bottom: 0.5rem;
      }

      .mb-2 {
        margin-bottom: 1rem;
      }

      .mb-3 {
        margin-bottom: 1.5rem;
      }

      .text-sm {
        font-size: 0.875rem;
      }

      .text-xs {
        font-size: 0.75rem;
      }

      .text-muted {
        color: var(--text-muted);
      }

      .text-secondary {
        color: var(--text-secondary);
      }

      .font-semibold {
        font-weight: 600;
      }

      .font-bold {
        font-weight: 700;
      }

      .font-mono {
        font-family: "JetBrains Mono", monospace;
      }

      /* =========================================================
       RESPONSIVE — 768px
       ========================================================= */

      @media (max-width: 768px) {
        .hero h1 {
          font-size: 1.75rem;
        }

        .hero {
          padding: 3rem 1.5rem;
        }

        .container {
          padding: 0 1rem;
        }

        .nav-tabs {
          overflow-x: auto;
          -ms-overflow-style: none;
          scrollbar-width: none;
          padding: 0.5rem 0.25rem;
        }

        .header {
          padding: 0 1rem;
        }

        .stepper {
          flex-direction: column;
          gap: 0.5rem;
        }

        .step::after {
          display: none;
        }

        .workspace-card {
          padding: 1.5rem;
        }

        .section-title {
          font-size: 1.25rem;
        }
      }

      /* =========================================================
       PRINT
       ========================================================= */

      @media print {
        .header,
        .theme-toggle,
        .nav-tabs {
          display: none;
        }

        .tab-content {
          display: block !important;
        }

        .card,
        .workspace-card {
          break-inside: avoid;
        }
      }
    </style>
  </head>
  <body>
    <!-- ============================================================
       HEADER
       ============================================================ -->
    <header class="header">
      <div class="header-left">
        <div class="header-logo">
          <!-- Circuit / Brain icon -->
          <svg
            width="28"
            height="28"
            viewBox="0 0 28 28"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <!-- Central node -->
            <circle cx="14" cy="14" r="3" fill="#6366f1" stroke="#6366f1" />
            <!-- Outer nodes -->
            <circle cx="5" cy="7" r="2" />
            <circle cx="23" cy="7" r="2" />
            <circle cx="5" cy="21" r="2" />
            <circle cx="23" cy="21" r="2" />
            <circle cx="14" cy="3" r="1.5" />
            <circle cx="14" cy="25" r="1.5" />
            <!-- Connections -->
            <line x1="11.5" y1="12" x2="6.5" y2="8.5" />
            <line x1="16.5" y1="12" x2="21.5" y2="8.5" />
            <line x1="11.5" y1="16" x2="6.5" y2="19.5" />
            <line x1="16.5" y1="16" x2="21.5" y2="19.5" />
            <line x1="14" y1="11" x2="14" y2="4.5" />
            <line x1="14" y1="17" x2="14" y2="23.5" />
            <!-- Cross connections -->
            <line x1="6.5" y1="9" x2="6.5" y2="19" opacity="0.4" />
            <line x1="21.5" y1="9" x2="21.5" y2="19" opacity="0.4" />
          </svg>
        </div>
        <span class="header-title">AI Evals Platform</span>
        <span class="header-badge">Interactive Guide</span>
      </div>
      <div class="header-right">
        <button class="theme-toggle" type="button" aria-label="Toggle theme">
          <!-- Sun icon (visible in dark mode) -->
          <svg
            class="icon-sun"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="5" />
            <line x1="12" y1="1" x2="12" y2="3" />
            <line x1="12" y1="21" x2="12" y2="23" />
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
            <line x1="1" y1="12" x2="3" y2="12" />
            <line x1="21" y1="12" x2="23" y2="12" />
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
          </svg>
          <!-- Moon icon (visible in light mode) -->
          <svg
            class="icon-moon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
          </svg>
        </button>
      </div>
    </header>

    <!-- ============================================================
       NAV TABS
       ============================================================ -->
    <nav class="nav-tabs container" role="tablist">
      <button
        class="nav-tab active"
        data-tab="overview"
        role="tab"
        aria-selected="true"
      >
        Overview
      </button>
      <button
        class="nav-tab"
        data-tab="workflows"
        role="tab"
        aria-selected="false"
      >
        Workflows
      </button>
      <button
        class="nav-tab"
        data-tab="api-auth"
        role="tab"
        aria-selected="false"
      >
        API & Auth
      </button>
      <button
        class="nav-tab"
        data-tab="prompts-schemas"
        role="tab"
        aria-selected="false"
      >
        Prompts & Schemas
      </button>
      <button
        class="nav-tab"
        data-tab="pipelines"
        role="tab"
        aria-selected="false"
      >
        Pipelines
      </button>
      <button
        class="nav-tab"
        data-tab="brain-map"
        role="tab"
        aria-selected="false"
      >
        Code Brain Map
      </button>
      <button
        class="nav-tab"
        data-tab="db-api-ref"
        role="tab"
        aria-selected="false"
      >
        DB & API Reference
      </button>
    </nav>

    <!-- ============================================================
       MAIN CONTENT
       ============================================================ -->
    <main class="container">
      <!-- ============================================================
     TAB 1: OVERVIEW
     ============================================================ -->
      <div id="tab-overview" class="tab-content active">
        <!-- Hero Section -->
        <div class="hero">
          <h1>AI Evals Platform</h1>
          <p class="hero-subtitle">
            An interactive guide to understanding how the platform evaluates AI
            systems across Voice RX, Kaira Bot, and Kaira Evals workspaces.
          </p>
        </div>

        <!-- Three Workspaces -->
        <h2 class="section-title">Three Workspaces</h2>
        <div class="grid-3">
          <!-- Voice RX -->
          <div class="card">
            <div class="card-body">
              <div class="icon-circle" style="background: #dbeafe">
                <svg
                  width="28"
                  height="28"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="#2563eb"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                  />
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                  <line x1="12" y1="19" x2="12" y2="23" />
                  <line x1="8" y1="23" x2="16" y2="23" />
                </svg>
              </div>
              <h3 class="card-title">Voice RX</h3>
              <p class="card-text">
                Evaluate medical voice transcription quality. Upload audio +
                transcripts, run AI-judged transcription and per-segment
                critique using a two-call LLM pipeline.
              </p>
              <div class="badge-row">
                <span class="badge badge-blue">Transcription</span>
                <span class="badge badge-purple">Evaluation</span>
              </div>
            </div>
          </div>

          <!-- Kaira Bot -->
          <div class="card">
            <div class="card-body">
              <div class="icon-circle" style="background: #d1fae5">
                <svg
                  width="28"
                  height="28"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="#059669"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                  />
                </svg>
              </div>
              <h3 class="card-title">Kaira Bot</h3>
              <p class="card-text">
                Test the Kaira health assistant chatbot. Run live chat sessions
                via SSE streaming, then evaluate conversations using custom
                evaluators with structured output schemas.
              </p>
              <div class="badge-row">
                <span class="badge badge-green">Chat</span>
                <span class="badge badge-purple">Evaluation</span>
              </div>
            </div>
          </div>

          <!-- Kaira Evals -->
          <div class="card">
            <div class="card-body">
              <div class="icon-circle" style="background: #ede9fe">
                <svg
                  width="28"
                  height="28"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="#7c3aed"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
              </div>
              <h3 class="card-title">Kaira Evals</h3>
              <p class="card-text">
                Batch and adversarial testing at scale. Upload CSV chat threads
                for batch evaluation, or run automated adversarial stress tests
                against the live Kaira API.
              </p>
              <div class="badge-row">
                <span class="badge badge-amber">Batch</span>
                <span class="badge badge-purple">Adversarial</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Technology Stack -->
        <h2 class="section-title">Technology Stack</h2>
        <div class="grid-3">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Frontend</h3>
              <ul class="tech-list">
                <li>React 19</li>
                <li>Vite</li>
                <li>TypeScript</li>
                <li>Zustand</li>
                <li>Tailwind CSS v4</li>
              </ul>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Backend</h3>
              <ul class="tech-list">
                <li>FastAPI</li>
                <li>async SQLAlchemy</li>
                <li>asyncpg</li>
                <li>Python</li>
              </ul>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Database</h3>
              <ul class="tech-list">
                <li>PostgreSQL 16</li>
                <li>JSONB columns</li>
                <li>Docker Compose</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Architecture Overview -->
        <h2 class="section-title">Architecture Overview</h2>
        <div class="card">
          <div class="card-body">
            <div class="mermaid">
graph TB
    Browser["Browser (React + Vite)"] -->|"/api/*"| Vite["Vite Dev Proxy :5173"]
    Vite -->|"Proxy"| FastAPI["FastAPI :8721"]
    FastAPI -->|"async SQLAlchemy"| PG["PostgreSQL :5432"]
    FastAPI -->|"Starts on boot"| Worker["Job Worker Loop"]
    Worker -->|"Polls every 5s"| PG
    Worker -->|"evaluate-voice-rx"| VRX["voice_rx_runner"]
    Worker -->|"evaluate-batch"| Batch["batch_runner"]
    Worker -->|"evaluate-adversarial"| Adv["adversarial_runner"]
    Worker -->|"evaluate-custom"| Custom["custom_evaluator_runner"]
    VRX -->|"API calls"| LLM["LLM Provider (Gemini / OpenAI)"]
    Batch --> LLM
    Adv --> LLM
    Custom --> LLM

    style Browser fill:#6366f1,color:#fff
    style FastAPI fill:#10b981,color:#fff
    style PG fill:#f59e0b,color:#fff
    style Worker fill:#8b5cf6,color:#fff
    style LLM fill:#ec4899,color:#fff
      </div>
          </div>
        </div>
      </div>

      <!-- ============================================================
     TAB 2: WORKFLOWS
     ============================================================ -->
      <div id="tab-workflows" class="tab-content">
        <!-- Universal Evaluation Pattern -->
        <h2 class="section-title">Universal Evaluation Pattern</h2>
        <div class="stepper">
          <div class="step">
            <div class="step-number">1</div>
            <div class="step-content">
              <h4 class="step-title">Bring Assets</h4>
              <p class="step-text">
                Upload audio, transcripts, CSVs, or connect to APIs.
              </p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">2</div>
            <div class="step-content">
              <h4 class="step-title">Review Setup</h4>
              <p class="step-text">
                Configure prompts, schemas, select models.
              </p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">3</div>
            <div class="step-content">
              <h4 class="step-title">Run Evaluators</h4>
              <p class="step-text">Execute standalone custom evaluators.</p>
            </div>
          </div>

          <div class="step">
            <div class="step-number">4</div>
            <div class="step-content">
              <h4 class="step-title">Run Full Evals</h4>
              <p class="step-text">Launch complete evaluation pipelines.</p>
            </div>
          </div>
        </div>

        <!-- Per-Workspace Workflows -->
        <h2 class="section-title">Per-Workspace Workflows</h2>

        <!-- Accordion: Voice RX -->
        <div class="accordion">
          <button class="accordion-toggle" type="button">
            <span class="accordion-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="6 9 12 15 18 9" />
              </svg>
            </span>
            <span>Voice RX Workflow</span>
          </button>
          <div class="accordion-body">
            <h4>Assets</h4>
            <p>
              Upload audio files (.mp3/.wav) and original transcript JSON with
              time-aligned segments. Alternatively, import from the VoiceRX API
              which provides audio + structured output (rx object) together.
            </p>

            <h4>Setup</h4>
            <p>
              Configure three types of prompts &mdash;
              <strong>transcription prompt</strong> (uses
              <code>{{audio}}</code>, <code>{{time_windows}}</code>,
              <code>{{segment_count}}</code>),
              <strong>evaluation prompt</strong> (uses
              <code>{{transcript}}</code>, <code>{{llm_transcript}}</code>,
              <code>{{original_script}}</code>), and optional
              <strong>normalization</strong>. Select per-step models. Define
              JSON schemas for structured LLM output enforcement.
            </p>

            <h4>Standalone Evaluators</h4>
            <p>
              Create custom evaluators using
              <code>InlineSchemaBuilder</code> (visual field builder). Each
              evaluator has a prompt template + output schema. Submitted as
              <code>'evaluate-custom'</code> job &rarr;
              <code>custom_evaluator_runner.py</code>.
            </p>

            <h4>Full Evaluation Pipeline</h4>
            <p>
              4-tab wizard (<strong
                >Settings &rarr; Transcription &rarr; Evaluation &rarr;
                Review</strong
              >). Submits <code>'evaluate-voice-rx'</code> job. Two-call
              pipeline:
            </p>
            <ul>
              <li>
                <strong>Call 1 (Transcription):</strong> Audio + prompt &rarr;
                LLM &rarr; AI transcript
              </li>
              <li>
                <strong>Call 2 (Critique):</strong> Audio + original + AI
                transcript &rarr; LLM &rarr; per-segment scores
              </li>
            </ul>

            <div class="mermaid">
sequenceDiagram
    participant FE as Frontend
    participant BE as FastAPI
    participant DB as PostgreSQL
    participant LLM as Gemini/OpenAI

    FE->>BE: POST /api/jobs (evaluate-voice-rx)
    BE->>DB: Create Job + EvalRun
    BE-->>FE: job_id

    Note over BE,LLM: Call 1: Transcription
    BE->>DB: Load listing + audio
    BE->>LLM: Audio + transcription prompt + schema
    LLM-->>BE: AI transcript (JSON)

    Note over BE,LLM: Call 2: Critique
    BE->>LLM: Audio + original + AI transcript + eval prompt
    LLM-->>BE: Per-segment critique (JSON)

    BE->>DB: Save EvalRun result
    FE->>BE: Poll job progress
    BE-->>FE: Status + result
      </div>
          </div>
        </div>

        <!-- Accordion: Kaira Bot -->
        <div class="accordion">
          <button class="accordion-toggle" type="button">
            <span class="accordion-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="6 9 12 15 18 9" />
              </svg>
            </span>
            <span>Kaira Bot Workflow</span>
          </button>
          <div class="accordion-body">
            <h4>Assets</h4>
            <p>
              Live chat sessions with the Kaira health assistant API. Messages
              are sent via SSE streaming endpoint (<code>/chat/stream</code>).
              Session management tracks <code>thread_id</code> and
              <code>server_session_id</code> across turns.
            </p>

            <h4>Setup</h4>
            <p>
              Define evaluator definitions &mdash; each evaluator has a prompt
              template that receives <code>{{chat_transcript}}</code> variable,
              plus an output schema built with <code>InlineSchemaBuilder</code>.
            </p>

            <h4>Evaluation</h4>
            <p>
              <code>useEvaluatorRunner</code> hook submits
              <code>'evaluate-custom'</code> job &rarr;
              <code>custom_evaluator_runner.py</code> loads the ChatSession +
              messages, resolves prompt variables, generates JSON schema from
              output definition, calls LLM, and saves EvalRun with extracted
              scores.
            </p>
          </div>
        </div>

        <!-- Accordion: Kaira Evals -->
        <div class="accordion">
          <button class="accordion-toggle" type="button">
            <span class="accordion-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="6 9 12 15 18 9" />
              </svg>
            </span>
            <span>Kaira Evals Workflow</span>
          </button>
          <div class="accordion-body">
            <h4>Batch Evaluation</h4>

            <p>
              <strong>Assets:</strong> Upload CSV file containing chat threads
              (columns: <code>thread_id</code>, <code>query_text</code>,
              <code>intent</code>, <code>final_response_message</code>, etc.).
            </p>

            <p>
              <strong>Setup:</strong> 6-step wizard (<strong
                >Info &rarr; CSV Upload &rarr; Scope &rarr; Evaluators &rarr;
                LLM Config &rarr; Review</strong
              >). Select built-in evaluators (Intent, Correctness, Efficiency)
              plus custom evaluators.
            </p>

            <p>
              <strong>Execution:</strong> <code>'evaluate-batch'</code> job
              &rarr; <code>batch_runner.py</code>. Loads CSV via DataLoader,
              iterates threads. Per thread: runs <code>IntentEvaluator</code>,
              <code>CorrectnessEvaluator</code>,
              <code>EfficiencyEvaluator</code>, plus any custom evaluators.
              Saves <code>ThreadEvaluation</code> rows. Produces summary with
              accuracy, verdict distributions.
            </p>

            <hr class="divider" />

            <h4>Adversarial Testing</h4>

            <p>
              <strong>Assets:</strong> Live Kaira API credentials (URL + auth
              token).
            </p>

            <p>
              <strong>Setup:</strong> 5-step wizard (<strong
                >Info &rarr; API Config &rarr; Test Config &rarr; LLM Config
                &rarr; Review</strong
              >). Configure test count, turn delay, case delay.
            </p>

            <p>
              <strong>Execution:</strong>
              <code>'evaluate-adversarial'</code> job &rarr;
              <code>adversarial_runner.py</code>.
            </p>
            <ul>
              <li>
                <strong>Phase 1:</strong> LLM generates diverse test cases
                (categories like manipulation, harmful content, boundary
                testing).
              </li>
              <li>
                <strong>Phase 2:</strong> <code>ConversationAgent</code> drives
                multi-turn conversations against live API.
              </li>
              <li>
                <strong>Phase 3:</strong> Judge LLM evaluates each transcript
                for safety/compliance.
              </li>
            </ul>
            <p>
              Saves <code>AdversarialEvaluation</code> rows with
              <code>verdict</code> and <code>goal_achieved</code>.
            </p>
          </div>
        </div>
      </div>

      <!-- ============================================================
     TAB 3: API & AUTH
     ============================================================ -->
      <div id="tab-api-auth" class="tab-content">
        <!-- LLM Provider Architecture -->
        <h2 class="section-title">LLM Provider Architecture</h2>
        <div class="grid-2">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Frontend Providers</h3>
              <table class="info-table">
                <tr>
                  <td class="info-label">Interface</td>
                  <td>
                    <code>ILLMProvider</code> (<code>src/services/llm/</code>)
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Implementations</td>
                  <td><code>GeminiProvider</code></td>
                </tr>
                <tr>
                  <td class="info-label">Used for</td>
                  <td>
                    Real-time AI-assist features in browser (API key mode)
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Pipeline</td>
                  <td>
                    <code>LLMInvocationPipeline</code> (Validate &rarr; Prepare
                    &rarr; Execute &rarr; Post-process)
                  </td>
                </tr>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Backend Providers</h3>
              <table class="info-table">
                <tr>
                  <td class="info-label">Base class</td>
                  <td>
                    <code>BaseLLMProvider</code>
                    (<code>app/services/evaluators/llm_base.py</code>)
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Implementations</td>
                  <td>
                    <code>GeminiProvider</code> (google-genai SDK),
                    <code>OpenAIProvider</code> (openai SDK)
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Used for</td>
                  <td>Background job evaluation pipelines</td>
                </tr>
                <tr>
                  <td class="info-label">Wrapper</td>
                  <td>
                    <code>LoggingLLMWrapper</code> (logs all API calls to
                    <code>api_logs</code> table)
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Methods</td>
                  <td>
                    <code>generate()</code>, <code>generate_json()</code>,
                    <code>generate_with_audio()</code>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>

        <!-- API Key Setup -->
        <h2 class="section-title">API Key Setup</h2>
        <div class="card">
          <div class="card-body">
            <p>
              <code>ProviderConfigCard.tsx</code> provides per-provider API key
              inputs. Keys are stored in the <strong>Settings</strong> table
              (key=<code>'llm-settings'</code>) as JSONB with fields:
              <code>provider</code>, <code>geminiApiKey</code>,
              <code>openaiApiKey</code>, <code>selectedModel</code>.
            </p>
            <p>
              On the frontend, <code>useLLMSettingsStore</code> (Zustand)
              manages the active configuration. On the backend,
              <code>settings_helper.get_llm_settings_from_db()</code> reads the
              same settings row to configure LLM providers for background jobs.
            </p>
          </div>
        </div>

        <!-- Service Account Authentication -->
        <h2 class="section-title">Service Account Authentication</h2>
        <div class="card">
          <div class="card-body">
            <p>
              For server-side Gemini calls, set the
              <code>GEMINI_SERVICE_ACCOUNT_PATH</code> env var pointing to a
              Google Cloud service account JSON file. The
              <code>settings_helper._detect_service_account_path()</code>
              function auto-detects it.
            </p>
            <p>
              When present, <code>GeminiProvider</code> creates a Vertex AI
              client with <strong>oauth2 credentials</strong> instead of API key
              auth. Both API key and service account can coexist &mdash;
              <strong>service account</strong> is used for background jobs,
              <strong>API key</strong> for frontend.
            </p>
          </div>
        </div>

        <!-- Credential Resolution Flow -->
        <h2 class="section-title">Credential Resolution Flow</h2>
        <div class="card">
          <div class="card-body">
            <div class="mermaid">
flowchart TD
    UI["Settings UI ProviderConfigCard"] -->|Save| DB["Settings Table JSONB"]
    Job["Job Handler"] -->|get_llm_settings_from_db| SH["settings_helper.py"]
    SH -->|SELECT| DB
    SH -->|detect_service_account_path| ENV["Env GEMINI_SERVICE_ACCOUNT_PATH"]
    SH -->|Returns| Config["api_key + provider + model + auth_method"]
    Config -->|create_llm_provider| Factory["LLM Factory"]
    Factory -->|service_account_path exists| Vertex["GeminiProvider Vertex AI"]
    Factory -->|api_key only| APIKey["GeminiProvider API Key"]
    Factory -->|provider is openai| OpenAI["OpenAIProvider"]
      </div>
          </div>
        </div>

        <!-- Model Discovery -->
        <h2 class="section-title">Model Discovery</h2>
        <div class="card">
          <div class="card-body">
            <p>
              Frontend <code>modelDiscovery.ts</code> calls the
              <code>/api/llm/models</code> endpoint which lists available models
              from the configured provider. Models are cached in
              <code>useLLMSettingsStore</code>.
            </p>
            <p>
              The <code>ModelSelector</code> component provides a searchable
              dropdown. The backend exposes both
              <code>/api/llm/models</code> (model listing) and
              <code>/api/llm/auth-status</code> (service account status) in
              <code>app/routes/llm.py</code>.
            </p>
          </div>
        </div>
      </div>
      <!-- ============================================================
     TAB 4: PROMPTS & SCHEMAS
     ============================================================ -->
      <div id="tab-prompts" class="tab-content">
        <!-- Why Prompts Matter -->
        <h2 class="section-title">Why Prompts Matter</h2>
        <p class="section-subtitle">
          Prompts are the control surface for LLM evaluations. They confine the
          AI's narrative to a structured evaluation layer &mdash; transforming
          open-ended language models into deterministic scoring engines.
          Template variables (<code>{{variable}}</code>) inject runtime context
          (audio files, transcripts, chat messages) while JSON schemas enforce
          output structure.
        </p>

        <!-- Template Variable Registry -->
        <h2 class="section-title">Template Variable Registry</h2>
        <p class="section-subtitle">
          All 15 template variables defined in variableRegistry.ts, organized by
          type and availability.
        </p>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Variable</th>
                <th>Type</th>
                <th>Description</th>
                <th>Apps</th>
                <th>Prompt Types</th>
                <th>Flows</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>{{audio}}</code></td>
                <td><span class="badge badge-amber">file</span></td>
                <td>Audio file for transcription/evaluation</td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>upload, api</td>
              </tr>
              <tr>
                <td><code>{{transcript}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>Original AI transcript (system under test)</td>
                <td>voice-rx</td>
                <td>evaluation, extraction</td>
                <td>upload, api</td>
              </tr>
              <tr>
                <td><code>{{llm_transcript}}</code></td>
                <td><span class="badge badge-purple">computed</span></td>
                <td>Judge AI transcript (generated in Call 1)</td>
                <td>voice-rx</td>
                <td>evaluation</td>
                <td>upload, api</td>
              </tr>
              <tr>
                <td><code>{{chat_transcript}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>Full conversation as plain User/Bot messages</td>
                <td>kaira-bot</td>
                <td>evaluation</td>
                <td>all</td>
              </tr>
              <tr>
                <td><code>{{time_windows}}</code></td>
                <td><span class="badge badge-purple">computed</span></td>
                <td>
                  Time windows from original transcript for segment-aligned
                  transcription
                </td>
                <td>voice-rx</td>
                <td>transcription</td>
                <td>upload</td>
              </tr>
              <tr>
                <td><code>{{segment_count}}</code></td>
                <td><span class="badge badge-purple">computed</span></td>
                <td>Number of segments in the original transcript</td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>upload</td>
              </tr>
              <tr>
                <td><code>{{speaker_list}}</code></td>
                <td><span class="badge badge-purple">computed</span></td>
                <td>Comma-separated list of speakers</td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>upload</td>
              </tr>
              <tr>
                <td><code>{{script_preference}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>
                  User preference for output script (devanagari, romanized,
                  auto)
                </td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>upload, api</td>
              </tr>
              <tr>
                <td><code>{{language_hint}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>Language hint for the audio (e.g., Hindi, Hinglish)</td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>upload, api</td>
              </tr>
              <tr>
                <td><code>{{preserve_code_switching}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>Whether to preserve code-switching (yes/no)</td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>upload, api</td>
              </tr>
              <tr>
                <td><code>{{original_script}}</code></td>
                <td><span class="badge badge-purple">computed</span></td>
                <td>Detected script of the original transcript</td>
                <td>voice-rx</td>
                <td>evaluation</td>
                <td>upload</td>
              </tr>
              <tr>
                <td><code>{{structured_output}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>
                  AI-generated structured data (rx object) from API response
                </td>
                <td>voice-rx</td>
                <td>evaluation</td>
                <td>api</td>
              </tr>
              <tr>
                <td><code>{{api_input}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>Input payload sent to the API (query/context)</td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>api</td>
              </tr>
              <tr>
                <td><code>{{api_rx}}</code></td>
                <td><span class="badge badge-blue">text</span></td>
                <td>Complete API response including metadata</td>
                <td>voice-rx</td>
                <td>transcription, evaluation</td>
                <td>api</td>
              </tr>
              <tr>
                <td><code>{{llm_structured}}</code></td>
                <td><span class="badge badge-purple">computed</span></td>
                <td>Structured data extracted by Judge AI (from Call 1)</td>
                <td>voice-rx</td>
                <td>evaluation</td>
                <td>upload, api</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Variable Resolution Flow -->
        <h2 class="section-title">Variable Resolution Flow</h2>
        <div class="card">
          <div class="card-body">
            <div class="mermaid">
flowchart LR
    Prompt["Prompt Template"] -->|"extractVariables()"| Extract["Extract {{var}} tokens"]
    Extract -->|"For each variable"| Resolve["resolveVariable()"]
    Resolve -->|"text type"| Sub["Substitute in prompt string"]
    Resolve -->|"file type"| Keep["Keep as placeholder (handled by LLM service)"]
    Resolve -->|"computed type"| Compute["Compute from context (transcript, AI eval)"]
    Compute --> Sub
    Sub --> Final["Resolved Prompt"]
    Keep --> Final

    style Prompt fill:#6366f1,color:#fff
    style Final fill:#10b981,color:#fff
      </div>
          </div>
        </div>

        <!-- Two Schema Systems -->
        <h2 class="section-title">Two Schema Systems</h2>
        <div class="grid-2">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">JSON Schema (SchemaDefinition)</h3>
              <table class="info-table">
                <tr>
                  <td class="info-label">Used in</td>
                  <td>
                    Evaluation overlays, passed directly to Gemini/OpenAI SDK
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Format</td>
                  <td>Standard JSON Schema with type, properties, required</td>
                </tr>
                <tr>
                  <td class="info-label">Purpose</td>
                  <td>
                    Enforces structured output from LLM (<code
                      >response_json_schema</code
                    >
                    in Gemini, <code>response_format</code> in OpenAI)
                  </td>
                </tr>
              </table>
              <pre
                class="code-block"
              ><button class="copy-btn" onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent)">Copy</button><code>{
  "type": "object",
  "properties": {
    "segments": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "speaker": { "type": "string" },
          "text": { "type": "string" },
          "score": { "type": "number" }
        },
        "required": ["speaker", "text", "score"]
      }
    }
  },
  "required": ["segments"]
}</code></pre>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Field-Based (EvaluatorOutputField[])</h3>
              <table class="info-table">
                <tr>
                  <td class="info-label">Used in</td>
                  <td>
                    Custom evaluators, built via
                    <code>InlineSchemaBuilder</code> visual editor
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Format</td>
                  <td>
                    Array of field definitions with key, type, label,
                    description, thresholds, isMainMetric, displayMode
                  </td>
                </tr>
                <tr>
                  <td class="info-label">Conversion</td>
                  <td>
                    <code>generateJsonSchema()</code> in schema_generator.py
                    converts to JSON Schema at runtime
                  </td>
                </tr>
              </table>
              <pre
                class="code-block"
              ><button class="copy-btn" onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent)">Copy</button><code>[
  {
    "key": "overall_score",
    "type": "number",
    "label": "Overall Score",
    "description": "0-100 quality score",
    "isMainMetric": true,
    "thresholds": { "red": 40, "yellow": 70, "green": 90 }
  },
  {
    "key": "reasoning",
    "type": "string",
    "label": "Reasoning",
    "description": "Explanation for the score"
  }
]</code></pre>
            </div>
          </div>
        </div>

        <!-- Prompt Template Example -->
        <h2 class="section-title">Prompt Template Example</h2>
        <div class="card">
          <div class="card-body">
            <pre
              class="code-block"
            ><button class="copy-btn" onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent)">Copy</button><code>You are an expert medical transcription evaluator.

Listen to the audio file: <span style="color:#818cf8">{{audio}}</span>

Compare the original transcript below with the AI-generated transcript.

=== ORIGINAL TRANSCRIPT ===
<span style="color:#818cf8">{{transcript}}</span>

=== AI TRANSCRIPT (Judge) ===
<span style="color:#818cf8">{{llm_transcript}}</span>

The original transcript uses <span style="color:#818cf8">{{original_script}}</span> script.
There are <span style="color:#818cf8">{{segment_count}}</span> segments to evaluate.

For each segment, provide:
- Accuracy score (0-100)
- Speaker identification correctness
- Medical terminology accuracy
- Overall assessment</code></pre>
          </div>
        </div>
      </div>

      <!-- ============================================================
     TAB 5: PIPELINES
     ============================================================ -->
      <div id="tab-pipelines" class="tab-content">
        <!-- Execution Pipelines -->
        <h2 class="section-title">Execution Pipelines</h2>
        <p class="section-subtitle">
          How evaluation jobs flow from user click to saved results.
        </p>

        <!-- Pipeline Toggle Pills -->
        <div class="filter-pills">
          <button
            class="filter-pill active"
            onclick="showPipeline('frontend', this)"
          >
            Frontend LLM Pipeline
          </button>
          <button class="filter-pill" onclick="showPipeline('backend', this)">
            Backend Job Pipeline
          </button>
          <button class="filter-pill" onclick="showPipeline('voicerx', this)">
            Voice RX Two-Call
          </button>
          <button class="filter-pill" onclick="showPipeline('batch', this)">
            Batch Pipeline
          </button>
          <button
            class="filter-pill"
            onclick="showPipeline('adversarial', this)"
          >
            Adversarial Pipeline
          </button>
        </div>

        <!-- PIPELINE VIEW 1: Frontend LLM Pipeline -->
        <div id="pipeline-frontend" style="display: block">
          <h3 class="section-title">Frontend LLM Pipeline</h3>
          <p class="section-subtitle">
            Used for real-time AI features in the browser. 4-stage pipeline in
            LLMInvocationPipeline.ts.
          </p>

          <div class="card">
            <div class="card-body">
              <div class="mermaid">
flowchart LR
    A["1. Validate"] -->|"Check API key, model"| B["2. Prepare"]
    B -->|"Build prompt, attach schema"| C["3. Execute"]
    C -->|"Call Gemini/OpenAI API"| D["4. Post-process"]
    D -->|"Parse JSON, validate schema"| E["Result"]

    style A fill:#6366f1,color:#fff
    style B fill:#8b5cf6,color:#fff
    style C fill:#a78bfa,color:#fff
    style D fill:#c4b5fd,color:#000
    style E fill:#10b981,color:#fff
        </div>
            </div>
          </div>

          <pre
            class="code-block"
          ><button class="copy-btn" onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent)">Copy</button><code>// src/services/llm/pipeline/index.ts
export function createLLMPipeline(): LLMInvocationPipeline {
  const { apiKey, selectedModel } = useLLMSettingsStore.getState();
  if (!apiKey) throw new Error('API key not configured');
  return new LLMInvocationPipeline(apiKey, selectedModel);
}</code></pre>
        </div>

        <!-- PIPELINE VIEW 2: Backend Job Pipeline -->
        <div id="pipeline-backend" style="display: none">
          <h3 class="section-title">Backend Job Pipeline</h3>
          <p class="section-subtitle">
            Background job processing via worker_loop() in job_worker.py.
          </p>

          <div class="card">
            <div class="card-body">
              <div class="mermaid">
flowchart TD
    Click["User clicks 'Run'"] -->|"POST /api/jobs"| Create["Create Job (status: queued)"]
    Create --> Queue["Jobs Table"]
    Worker["worker_loop()"] -->|"Polls every 5s"| Queue
    Worker -->|"Picks oldest queued"| Mark["Mark as 'running'"]
    Mark -->|"process_job()"| Dispatch["JOB_HANDLERS registry"]
    Dispatch -->|"evaluate-voice-rx"| VRX["voice_rx_runner.py"]
    Dispatch -->|"evaluate-batch"| Batch["batch_runner.py"]
    Dispatch -->|"evaluate-adversarial"| Adv["adversarial_runner.py"]
    Dispatch -->|"evaluate-custom"| Custom["custom_evaluator_runner.py"]
    VRX --> Save["Save EvalRun + mark Job completed"]
    Batch --> Save
    Adv --> Save
    Custom --> Save

    style Click fill:#6366f1,color:#fff
    style Worker fill:#8b5cf6,color:#fff
    style Save fill:#10b981,color:#fff
        </div>
            </div>
          </div>

          <pre
            class="code-block"
          ><button class="copy-btn" onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent)">Copy</button><code># job_worker.py — Handler registry
@register_job_handler("evaluate-voice-rx")
async def handle_evaluate_voice_rx(job_id, params):
    return await run_voice_rx_evaluation(job_id=job_id, params=params)

@register_job_handler("evaluate-batch")
async def handle_evaluate_batch(job_id, params):
    return await run_batch_evaluation(job_id=job_id, ...)

@register_job_handler("evaluate-adversarial")
async def handle_evaluate_adversarial(job_id, params):
    return await run_adversarial_evaluation(job_id=job_id, ...)</code></pre>
        </div>

        <!-- PIPELINE VIEW 3: Voice RX Two-Call -->
        <div id="pipeline-voicerx" style="display: none">
          <h3 class="section-title">Voice RX Two-Call Pipeline (Detailed)</h3>

          <div class="card">
            <div class="card-body">
              <div class="mermaid">
flowchart TD
    Start["run_voice_rx_evaluation()"] --> Load["Load Listing + Audio from DB"]
    Load --> Settings["get_llm_settings_from_db()"]
    Settings --> Provider["create_llm_provider() + LoggingLLMWrapper"]
    Provider --> Check{"skip_transcription?"}

    Check -->|No| Call1["CALL 1: Transcription"]
    Check -->|Yes| Reuse["Reuse previous AI transcript"]

    Call1 --> Resolve1["resolve_prompt(transcription_prompt)"]
    Resolve1 --> LLM1["llm.generate_with_audio(prompt, audio, schema)"]
    LLM1 --> Parse1["parse_transcript_response()"]
    Parse1 --> Norm{"normalize_original?"}

    Norm -->|Yes| NormStep["Normalize: transliterate script"]
    Norm -->|No| Call2["CALL 2: Critique"]
    NormStep --> Call2
    Reuse --> Call2

    Call2 --> Resolve2["resolve_prompt(evaluation_prompt)"]
    Resolve2 --> LLM2["llm.generate_with_audio(prompt, audio, schema)"]
    LLM2 --> Parse2["parse_critique_response()"]
    Parse2 --> Save["Save EvalRun to DB"]

    style Start fill:#6366f1,color:#fff
    style Call1 fill:#f59e0b,color:#fff
    style Call2 fill:#ec4899,color:#fff
    style Save fill:#10b981,color:#fff
        </div>
            </div>
          </div>
        </div>

        <!-- PIPELINE VIEW 4: Batch Pipeline -->
        <div id="pipeline-batch" style="display: none">
          <h3 class="section-title">Batch Evaluation Pipeline</h3>

          <div class="card">
            <div class="card-body">
              <div class="mermaid">
flowchart TD
    Start["run_batch_evaluation()"] --> LoadCSV["DataLoader: parse CSV"]
    LoadCSV --> Resolve["Resolve thread IDs (all / sample / selected)"]
    Resolve --> Loop["For each thread_id"]
    Loop --> GetThread["loader.get_thread(id)"]
    GetThread --> Intent["IntentEvaluator.evaluate_thread()"]
    Intent --> Correct["CorrectnessEvaluator.evaluate_thread()"]
    Correct --> Effic["EfficiencyEvaluator.evaluate_thread()"]
    Effic --> CustomEvals["Custom evaluators (resolve_prompt + generate_json)"]
    CustomEvals --> SaveThread["Save ThreadEvaluation row"]
    SaveThread -->|"Next thread"| Loop
    SaveThread -->|"All done"| Summary["Compute summary + save EvalRun"]

    style Start fill:#6366f1,color:#fff
    style Loop fill:#8b5cf6,color:#fff
    style Summary fill:#10b981,color:#fff
        </div>
            </div>
          </div>
        </div>

        <!-- PIPELINE VIEW 5: Adversarial Pipeline -->
        <div id="pipeline-adversarial" style="display: none">
          <h3 class="section-title">Adversarial Testing Pipeline</h3>

          <div class="card">
            <div class="card-body">
              <div class="mermaid">
flowchart TD
    Start["run_adversarial_evaluation()"] --> Gen["Phase 1: Generate Test Cases"]
    Gen -->|"AdversarialEvaluator.generate_test_cases(n)"| Cases["Test Cases (categories + difficulty)"]
    Cases --> Loop["For each test case"]
    Loop --> Conv["Phase 2: ConversationAgent.run_conversation()"]
    Conv -->|"Multi-turn SSE chat"| Kaira["Live Kaira API"]
    Kaira --> Transcript["Conversation Transcript"]
    Transcript --> Judge["Phase 3: evaluate_transcript()"]
    Judge -->|"LLM judges safety/compliance"| Verdict["Verdict + goal_achieved"]
    Verdict --> SaveAdv["Save AdversarialEvaluation row"]
    SaveAdv -->|"Next case"| Loop
    SaveAdv -->|"All done"| Summary["Summary: verdict distribution + goal counts"]

    style Start fill:#6366f1,color:#fff
    style Gen fill:#f59e0b,color:#fff
    style Conv fill:#ec4899,color:#fff
    style Judge fill:#8b5cf6,color:#fff
    style Summary fill:#10b981,color:#fff
        </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ============================================================
     TAB 6: CODE BRAIN MAP
     ============================================================ -->
      <div id="tab-brainmap" class="tab-content">
        <h2 class="section-title">Code Brain Map</h2>
        <p class="section-subtitle">
          Interactive force-directed graph showing how features, files, and
          methods connect across the codebase.
        </p>

        <!-- Controls Row -->
        <div
          style="
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
          "
        >
          <div class="search-wrapper">
            <svg
              class="search-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input
              id="brain-search"
              class="search-input"
              type="text"
              placeholder="Search files or methods..."
            />
          </div>
          <div class="filter-pills">
            <button class="filter-pill active" data-layer="all">All</button>
            <button class="filter-pill" data-layer="frontend">Frontend</button>
            <button class="filter-pill" data-layer="backend">Backend</button>
            <button class="filter-pill" data-layer="shared">Shared</button>
          </div>
        </div>

        <!-- Feature Selector Pills -->
        <div class="filter-pills" id="feature-pills">
          <button class="filter-pill active" data-feature="all">
            All Features
          </button>
          <button class="filter-pill" data-feature="voice-rx-eval">
            Voice RX Eval
          </button>
          <button class="filter-pill" data-feature="batch-eval">
            Batch Eval
          </button>
          <button class="filter-pill" data-feature="adversarial">
            Adversarial
          </button>
          <button class="filter-pill" data-feature="custom-evaluators">
            Custom Evaluators
          </button>
          <button class="filter-pill" data-feature="template-vars">
            Template Vars
          </button>
          <button class="filter-pill" data-feature="llm-pipeline">
            LLM Pipeline
          </button>
          <button class="filter-pill" data-feature="settings-config">
            Settings &amp; Config
          </button>
        </div>

        <!-- SVG Container -->
        <svg id="brain-map-svg"></svg>

        <!-- Info Panel -->
        <div id="brain-info" class="info-panel">
          <p style="color: var(--text-muted)">
            Click on a node to see details. Use feature pills above to highlight
            subgraphs.
          </p>
        </div>
      </div>

      <!-- ============================================================
     TAB 7: DB & API REFERENCE
     ============================================================ -->
      <div id="tab-db-api" class="tab-content">
        <!-- Database Models -->
        <h2 class="section-title">Database Models</h2>
        <p class="section-subtitle">
          15 SQLAlchemy models across 11 model files, all using PostgreSQL with
          JSONB columns.
        </p>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Model</th>
                <th>Table</th>
                <th>Key Columns</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>Listing</code></td>
                <td><code>listings</code></td>
                <td>
                  <code>id</code> (UUID), <code>app_id</code>,
                  <code>title</code>, <code>status</code>,
                  <code>source_type</code>, <code>audio_file</code> (JSONB),
                  <code>transcript</code> (JSONB),
                  <code>api_response</code> (JSONB)
                </td>
                <td>
                  Voice RX audio recordings with transcripts and API responses
                </td>
              </tr>
              <tr>
                <td><code>FileRecord</code></td>
                <td><code>files</code></td>
                <td>
                  <code>id</code> (UUID), <code>original_name</code>,
                  <code>mime_type</code>, <code>size_bytes</code>,
                  <code>storage_path</code>
                </td>
                <td>Binary file storage metadata (audio files, uploads)</td>
              </tr>
              <tr>
                <td><code>Prompt</code></td>
                <td><code>prompts</code></td>
                <td>
                  <code>id</code> (int), <code>app_id</code>,
                  <code>prompt_type</code>, <code>version</code>,
                  <code>name</code>, <code>prompt</code> (text),
                  <code>is_default</code>
                </td>
                <td>Versioned prompt templates per app and type</td>
              </tr>
              <tr>
                <td><code>Schema</code></td>
                <td><code>schemas</code></td>
                <td>
                  <code>id</code> (int), <code>app_id</code>,
                  <code>prompt_type</code>, <code>version</code>,
                  <code>name</code>, <code>schema_data</code> (JSONB),
                  <code>is_default</code>
                </td>
                <td>JSON schemas for LLM output enforcement</td>
              </tr>
              <tr>
                <td><code>Evaluator</code></td>
                <td><code>evaluators</code></td>
                <td>
                  <code>id</code> (UUID), <code>app_id</code>,
                  <code>name</code>, <code>prompt</code> (text),
                  <code>model_id</code>, <code>output_schema</code> (JSONB),
                  <code>is_global</code>
                </td>
                <td>Custom evaluator definitions with field-based schemas</td>
              </tr>
              <tr>
                <td><code>Setting</code></td>
                <td><code>settings</code></td>
                <td>
                  <code>id</code> (int), <code>app_id</code>, <code>key</code>,
                  <code>value</code> (JSONB)
                </td>
                <td>
                  App configuration including LLM API keys and preferences
                </td>
              </tr>
              <tr>
                <td><code>ChatSession</code></td>
                <td><code>chat_sessions</code></td>
                <td>
                  <code>id</code> (UUID), <code>app_id</code>,
                  <code>thread_id</code>, <code>server_session_id</code>,
                  <code>title</code>, <code>status</code>
                </td>
                <td>Kaira Bot chat session tracking</td>
              </tr>
              <tr>
                <td><code>ChatMessage</code></td>
                <td><code>chat_messages</code></td>
                <td>
                  <code>id</code> (UUID), <code>session_id</code> (FK),
                  <code>role</code>, <code>content</code> (text),
                  <code>metadata</code> (JSONB)
                </td>
                <td>Individual chat messages within sessions</td>
              </tr>
              <tr>
                <td><code>Job</code></td>
                <td><code>jobs</code></td>
                <td>
                  <code>id</code> (UUID), <code>job_type</code>,
                  <code>status</code>, <code>params</code> (JSONB),
                  <code>result</code> (JSONB), <code>progress</code> (JSONB),
                  <code>error_message</code>
                </td>
                <td>Background job queue for evaluation tasks</td>
              </tr>
              <tr>
                <td><code>EvalRun</code></td>
                <td><code>eval_runs</code></td>
                <td>
                  <code>id</code> (UUID), <code>app_id</code>,
                  <code>eval_type</code>, <code>listing_id</code> (FK),
                  <code>session_id</code> (FK), <code>evaluator_id</code> (FK),
                  <code>job_id</code> (FK), <code>status</code>,
                  <code>config</code> (JSONB), <code>result</code> (JSONB),
                  <code>summary</code> (JSONB)
                </td>
                <td>Central evaluation results table</td>
              </tr>
              <tr>
                <td><code>ThreadEvaluation</code></td>
                <td><code>thread_evaluations</code></td>
                <td>
                  <code>id</code> (int), <code>run_id</code> (FK),
                  <code>thread_id</code>, <code>intent_accuracy</code>,
                  <code>worst_correctness</code>,
                  <code>efficiency_verdict</code>, <code>result</code> (JSONB)
                </td>
                <td>Per-thread results for batch evaluations</td>
              </tr>
              <tr>
                <td><code>AdversarialEvaluation</code></td>
                <td><code>adversarial_evaluations</code></td>
                <td>
                  <code>id</code> (int), <code>run_id</code> (FK),
                  <code>category</code>, <code>difficulty</code>,
                  <code>verdict</code>, <code>goal_achieved</code>,
                  <code>total_turns</code>, <code>result</code> (JSONB)
                </td>
                <td>Per-test-case results for adversarial runs</td>
              </tr>
              <tr>
                <td><code>ApiLog</code></td>
                <td><code>api_logs</code></td>
                <td>
                  <code>id</code> (int), <code>run_id</code> (FK),
                  <code>thread_id</code>, <code>provider</code>,
                  <code>model</code>, <code>method</code>,
                  <code>prompt</code> (text), <code>response</code> (text),
                  <code>duration_ms</code>, <code>tokens_in</code>,
                  <code>tokens_out</code>
                </td>
                <td>LLM API call logs for debugging and cost tracking</td>
              </tr>
              <tr>
                <td><code>Tag</code></td>
                <td><code>tags</code></td>
                <td>
                  <code>id</code> (int), <code>app_id</code>, <code>name</code>,
                  <code>count</code>, <code>last_used</code>
                </td>
                <td>Listing tags for organization</td>
              </tr>
              <tr>
                <td><code>History</code></td>
                <td><code>history</code></td>
                <td>
                  <code>id</code> (UUID), <code>app_id</code>,
                  <code>entity_type</code>, <code>entity_id</code>,
                  <code>source_type</code>, <code>status</code>,
                  <code>duration_ms</code>, <code>data</code> (JSONB),
                  <code>timestamp</code>
                </td>
                <td>Activity history and audit log</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Entity Relationships -->
        <h2 class="section-title mt-3">Entity Relationships</h2>
        <div class="mermaid">
erDiagram
    Listing ||--o{ EvalRun : has
    ChatSession ||--o{ ChatMessage : contains
    ChatSession ||--o{ EvalRun : has
    Evaluator ||--o{ EvalRun : used_in
    Job ||--o{ EvalRun : triggers
    EvalRun ||--o{ ThreadEvaluation : produces
    EvalRun ||--o{ AdversarialEvaluation : produces
    EvalRun ||--o{ ApiLog : logs

    Listing {
        UUID id PK
        string app_id
        JSONB transcript
        JSONB audio_file
    }
    EvalRun {
        UUID id PK
        string eval_type
        string status
        JSONB result
        JSONB summary
    }
    Job {
        UUID id PK
        string job_type
        string status
        JSONB params
    }
    Evaluator {
        UUID id PK
        string name
        text prompt
        JSONB output_schema
    }
    ChatSession {
        UUID id PK
        string app_id
        string thread_id
        string title
    }
    ChatMessage {
        UUID id PK
        UUID session_id FK
        string role
        text content
    }
    ThreadEvaluation {
        int id PK
        UUID run_id FK
        string thread_id
        JSONB result
    }
    AdversarialEvaluation {
        int id PK
        UUID run_id FK
        string category
        string verdict
    }
    ApiLog {
        int id PK
        UUID run_id FK
        string provider
        string model
    }
  </div>

        <!-- API Routes -->
        <h2 class="section-title mt-3">API Routes</h2>
        <p class="section-subtitle">
          13 routers registered in main.py, all prefixed with /api/.
        </p>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Router</th>
                <th>Prefix</th>
                <th>Key Endpoints</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>listings</code></td>
                <td><code>/api/listings</code></td>
                <td>
                  <code>GET /</code>, <code>POST /</code>,
                  <code>GET /:id</code>, <code>PUT /:id</code>,
                  <code>DELETE /:id</code>
                </td>
                <td>CRUD for Voice RX listings (audio + transcript records)</td>
              </tr>
              <tr>
                <td><code>files</code></td>
                <td><code>/api/files</code></td>
                <td>
                  <code>POST /upload</code>, <code>GET /:id/download</code>
                </td>
                <td>File upload to local/Azure Blob storage, download by ID</td>
              </tr>
              <tr>
                <td><code>prompts</code></td>
                <td><code>/api/prompts</code></td>
                <td>
                  <code>GET /</code>, <code>POST /</code>,
                  <code>PUT /:id</code>, <code>DELETE /:id</code>
                </td>
                <td>Versioned prompt template management</td>
              </tr>
              <tr>
                <td><code>schemas</code></td>
                <td><code>/api/schemas</code></td>
                <td>
                  <code>GET /</code>, <code>POST /</code>,
                  <code>PUT /:id</code>, <code>DELETE /:id</code>
                </td>
                <td>JSON schema management for LLM output</td>
              </tr>
              <tr>
                <td><code>evaluators</code></td>
                <td><code>/api/evaluators</code></td>
                <td>
                  <code>GET /</code>, <code>POST /</code>,
                  <code>PUT /:id</code>, <code>DELETE /:id</code>
                </td>
                <td>Custom evaluator definition CRUD</td>
              </tr>
              <tr>
                <td><code>chat</code></td>
                <td><code>/api/chat</code></td>
                <td>
                  <code>GET /sessions</code>, <code>POST /sessions</code>,
                  <code>GET /sessions/:id/messages</code>,
                  <code>POST /messages</code>
                </td>
                <td>Kaira Bot chat session management</td>
              </tr>
              <tr>
                <td><code>history</code></td>
                <td><code>/api/history</code></td>
                <td><code>GET /</code>, <code>POST /</code></td>
                <td>Activity history and audit logging</td>
              </tr>
              <tr>
                <td><code>settings</code></td>
                <td><code>/api/settings</code></td>
                <td><code>GET /:key</code>, <code>PUT /:key</code></td>
                <td>App settings including LLM configuration</td>
              </tr>
              <tr>
                <td><code>tags</code></td>
                <td><code>/api/tags</code></td>
                <td>
                  <code>GET /</code>, <code>POST /</code>,
                  <code>DELETE /:id</code>
                </td>
                <td>Listing tag management</td>
              </tr>
              <tr>
                <td><code>jobs</code></td>
                <td><code>/api/jobs</code></td>
                <td>
                  <code>POST /</code>, <code>GET /:id</code>,
                  <code>POST /:id/cancel</code>
                </td>
                <td>Background job submission, status polling, cancellation</td>
              </tr>
              <tr>
                <td><code>eval_runs</code></td>
                <td><code>/api/eval-runs</code></td>
                <td>
                  <code>GET /</code>, <code>GET /:id</code>,
                  <code>DELETE /:id</code>
                </td>
                <td>Evaluation run results and history</td>
              </tr>
              <tr>
                <td><code>llm</code></td>
                <td><code>/api/llm</code></td>
                <td><code>GET /auth-status</code>, <code>GET /models</code></td>
                <td>Available LLM model discovery</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- API Client Pattern -->
        <h2 class="section-title mt-3">API Client Pattern</h2>
        <pre
          class="code-block"
        ><button class="copy-btn" onclick="navigator.clipboard.writeText(this.parentElement.querySelector('code').textContent)">Copy</button><code class="language-typescript">// Frontend API client (src/services/api/client.ts)
import { apiRequest, apiUpload, apiDownload } from '@/services/api/client';

// GET request with query params
const listings = await apiRequest&lt;Listing[]&gt;('/api/listings?app_id=voice-rx');

// POST with JSON body
const job = await apiRequest&lt;Job&gt;('/api/jobs', {
  method: 'POST',
  body: JSON.stringify({ job_type: 'evaluate-voice-rx', params: {...} })
});

// File upload (multipart/form-data)
const file = await apiUpload('/api/files/upload', formData);

// Binary download
const blob = await apiDownload('/api/files/{id}/download');</code></pre>
      </div>
    </main>

    <!-- ============================================================
       FOOTER
       ============================================================ -->
    <footer class="footer">
      <div class="container">
        <p>AI Evals Platform — Interactive Guide</p>
        <p style="margin-top: 0.5rem">
          Built with React, FastAPI, and PostgreSQL. Three workspaces, one
          unified evaluation engine.
        </p>
      </div>
    </footer>
    <script>
      (function () {
        // =========================================================
        // 1. THEME TOGGLE
        // =========================================================
        const html = document.documentElement;
        const themeToggle = document.querySelector(".theme-toggle");
        const sunIcon = document.querySelector(".icon-sun");
        const moonIcon = document.querySelector(".icon-moon");

        function setTheme(theme) {
          html.setAttribute("data-theme", theme);
          localStorage.setItem("theme", theme);
          if (themeToggle) {
            themeToggle.setAttribute(
              "aria-pressed",
              theme === "dark" ? "true" : "false",
            );
          }
          if (sunIcon && moonIcon) {
            sunIcon.style.display = theme === "dark" ? "block" : "none";
            moonIcon.style.display = theme === "light" ? "block" : "none";
          }
          // Re-render mermaid diagrams for new theme
          renderMermaidDiagrams();
        }

        // Initialize theme from localStorage or system preference
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        setTheme(savedTheme || (prefersDark ? "dark" : "light"));

        function toggleTheme() {
          const current = html.getAttribute("data-theme");
          setTheme(current === "dark" ? "light" : "dark");
        }

        if (themeToggle) {
          themeToggle.addEventListener("click", toggleTheme);
        }

        // =========================================================
        // 2. TAB NAVIGATION
        // =========================================================
        const tabs = document.querySelectorAll(".nav-tab");
        const tabContents = document.querySelectorAll(".tab-content");

        // Map data-tab values to content div IDs (they don't follow a simple pattern)
        const tabIdMap = {
          overview: "tab-overview",
          workflows: "tab-workflows",
          "api-auth": "tab-api-auth",
          "prompts-schemas": "tab-prompts",
          pipelines: "tab-pipelines",
          "brain-map": "tab-brainmap",
          "db-api-ref": "tab-db-api",
        };

        function isMermaidVisible(el) {
          if (!el) {
            return false;
          }
          var style = window.getComputedStyle(el);
          return (
            el.offsetParent !== null &&
            style.display !== "none" &&
            style.visibility !== "hidden"
          );
        }

        function runMermaid(nodes) {
          if (!nodes || nodes.length === 0) {
            return;
          }
          mermaid.run({ nodes: nodes }).catch(function (err) {
            console.warn("Mermaid render skipped:", err);
          });
        }

        function switchTab(tabId) {
          tabs.forEach(function (t) {
            t.classList.remove("active");
            t.setAttribute("aria-selected", "false");
          });
          tabContents.forEach(function (tc) {
            tc.classList.remove("active");
          });

          var activeTab = document.querySelector(
            '.nav-tab[data-tab="' + tabId + '"]',
          );
          var contentId = tabIdMap[tabId] || "tab-" + tabId;
          var activeContent = document.getElementById(contentId);

          if (activeTab) {
            activeTab.classList.add("active");
            activeTab.setAttribute("aria-selected", "true");
          }
          if (activeContent) activeContent.classList.add("active");

          // Update URL hash
          history.replaceState(null, "", "#" + tabId);

          // Initialize D3 brain map when tab is selected
          if (tabId === "brain-map" && !window._brainMapInitialized) {
            initBrainMap();
            window._brainMapInitialized = true;
          }

          // Re-render any mermaid diagrams in the now-visible tab
          if (activeContent) {
            activeContent.querySelectorAll(".mermaid").forEach(function (el) {
              if (!el.getAttribute("data-processed") && isMermaidVisible(el)) {
                runMermaid([el]);
              }
            });
          }
        }

        tabs.forEach(function (tab) {
          tab.addEventListener("click", function () {
            switchTab(tab.dataset.tab);
          });
        });

        // Handle URL hash on load
        var hash = location.hash.replace("#", "");
        if (hash && tabIdMap[hash]) {
          switchTab(hash);
        }

        // Keyboard navigation (left/right arrows when tabs focused)
        var navTabsContainer = document.querySelector(".nav-tabs");
        if (navTabsContainer) {
          navTabsContainer.addEventListener("keydown", function (e) {
            var tabArray = Array.from(tabs);
            var current = tabArray.findIndex(function (t) {
              return t.classList.contains("active");
            });
            if (e.key === "ArrowRight" && current < tabArray.length - 1) {
              switchTab(tabArray[current + 1].dataset.tab);
              tabArray[current + 1].focus();
            } else if (e.key === "ArrowLeft" && current > 0) {
              switchTab(tabArray[current - 1].dataset.tab);
              tabArray[current - 1].focus();
            }
          });
        }

        // =========================================================
        // 3. MERMAID INITIALIZATION
        // =========================================================
        function renderMermaidDiagrams() {
          var theme = html.getAttribute("data-theme");
          mermaid.initialize({
            startOnLoad: false,
            theme: theme === "dark" ? "dark" : "default",
            themeVariables:
              theme === "dark"
                ? {
                    primaryColor: "#818cf8",
                    primaryTextColor: "#f1f5f9",
                    primaryBorderColor: "#6366f1",
                    lineColor: "#64748b",
                    secondaryColor: "#1e293b",
                    tertiaryColor: "#334155",
                    background: "#0f172a",
                    mainBkg: "#1e293b",
                    nodeBorder: "#6366f1",
                  }
                : {
                    primaryColor: "#6366f1",
                    primaryTextColor: "#ffffff",
                    primaryBorderColor: "#4338ca",
                    lineColor: "#94a3b8",
                    secondaryColor: "#f1f5f9",
                    tertiaryColor: "#e2e8f0",
                  },
            flowchart: { curve: "basis", htmlLabels: true },
            sequence: { actorMargin: 50, mirrorActors: false },
          });

          // Reset all mermaid diagrams and re-render
          document.querySelectorAll(".mermaid").forEach(function (el) {
            if (el.getAttribute("data-processed")) {
              var original = el.getAttribute("data-original");
              if (original) {
                el.removeAttribute("data-processed");
                el.innerHTML = original;
              }
            } else {
              // Store original content before first render
              el.setAttribute("data-original", el.innerHTML);
            }
          });

          var visibleMermaidNodes = Array.from(
            document.querySelectorAll(".mermaid"),
          ).filter(isMermaidVisible);
          if (visibleMermaidNodes.length > 0) {
            runMermaid(visibleMermaidNodes);
          }
        }

        // Initial render after a brief delay so the DOM is ready
        setTimeout(renderMermaidDiagrams, 100);

        // =========================================================
        // 4. ACCORDION COMPONENTS
        // =========================================================
        document
          .querySelectorAll(".accordion-toggle")
          .forEach(function (toggle) {
            toggle.addEventListener("click", function () {
              var accordion = toggle.closest(".accordion");
              if (accordion) {
                accordion.classList.toggle("active");
              }
            });
          });

        // =========================================================
        // 5. COPY CODE BUTTONS
        // =========================================================
        document.querySelectorAll("pre.code-block").forEach(function (pre) {
          // Skip if a copy button already exists (some were added inline in HTML)
          if (pre.querySelector(".copy-btn")) return;

          var btn = document.createElement("button");
          btn.className = "copy-btn";
          btn.textContent = "Copy";
          btn.addEventListener("click", function () {
            var codeEl = pre.querySelector("code");
            var code = codeEl ? codeEl.textContent : pre.textContent;
            navigator.clipboard
              .writeText(code)
              .then(function () {
                btn.textContent = "Copied!";
                setTimeout(function () {
                  btn.textContent = "Copy";
                }, 2000);
              })
              .catch(function () {
                btn.textContent = "Failed";
                setTimeout(function () {
                  btn.textContent = "Copy";
                }, 2000);
              });
          });
          pre.style.position = "relative";
          pre.appendChild(btn);
        });

        // =========================================================
        // 6. PIPELINE VIEW TOGGLE
        // =========================================================
        // Pipeline pills use onclick="showPipeline('name', this)" in HTML
        window.showPipeline = function (target, clickedPill) {
          // Deactivate all pipeline pills in the same container
          var container = clickedPill.parentElement;
          container.querySelectorAll(".filter-pill").forEach(function (p) {
            p.classList.remove("active");
          });
          clickedPill.classList.add("active");

          // Hide all pipeline views
          var pipelineIds = [
            "pipeline-frontend",
            "pipeline-backend",
            "pipeline-voicerx",
            "pipeline-batch",
            "pipeline-adversarial",
          ];
          pipelineIds.forEach(function (id) {
            var el = document.getElementById(id);
            if (el) el.style.display = "none";
          });

          // Show selected pipeline view
          var targetView = document.getElementById("pipeline-" + target);
          if (targetView) {
            targetView.style.display = "block";
            // Re-render mermaid in newly visible section
            targetView.querySelectorAll(".mermaid").forEach(function (el) {
              if (!el.getAttribute("data-processed") && isMermaidVisible(el)) {
                runMermaid([el]);
              }
            });
          }
        };

        // =========================================================
        // 7. D3.JS BRAIN MAP
        // =========================================================
        function initBrainMap() {
          // -------------------------------------------------------
          // 7a. Define node data
          // -------------------------------------------------------
          var featureNodes = [
            {
              id: "feat-voice-rx-eval",
              label: "Voice RX Evaluation",
              type: "feature",
              layer: "shared",
              feature: "voice-rx-eval",
            },
            {
              id: "feat-batch-eval",
              label: "Batch Evaluation",
              type: "feature",
              layer: "shared",
              feature: "batch-eval",
            },
            {
              id: "feat-adversarial",
              label: "Adversarial Testing",
              type: "feature",
              layer: "shared",
              feature: "adversarial",
            },
            {
              id: "feat-custom-evaluators",
              label: "Custom Evaluators",
              type: "feature",
              layer: "shared",
              feature: "custom-evaluators",
            },
            {
              id: "feat-template-vars",
              label: "Template Variables",
              type: "feature",
              layer: "frontend",
              feature: "template-vars",
            },
            {
              id: "feat-llm-pipeline",
              label: "LLM Pipeline",
              type: "feature",
              layer: "shared",
              feature: "llm-pipeline",
            },
            {
              id: "feat-settings-config",
              label: "Settings & Config",
              type: "feature",
              layer: "shared",
              feature: "settings-config",
            },
          ];

          // Voice RX Evaluation files
          var vrxFiles = [
            {
              id: "file-voice-rx-runner",
              label: "voice_rx_runner.py",
              type: "file",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/voice_rx_runner.py",
            },
            {
              id: "file-evaluation-overlay",
              label: "EvaluationOverlay.tsx",
              type: "file",
              layer: "frontend",
              feature: "voice-rx-eval",
              fullPath: "src/features/evals/components/EvaluationOverlay.tsx",
            },
            {
              id: "file-use-ai-evaluation",
              label: "useAIEvaluation.ts",
              type: "file",
              layer: "frontend",
              feature: "voice-rx-eval",
              fullPath: "src/features/evals/hooks/useAIEvaluation.ts",
            },
            {
              id: "file-response-parser",
              label: "response_parser.py",
              type: "file",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/response_parser.py",
            },
            {
              id: "file-prompt-resolver",
              label: "prompt_resolver.py",
              type: "file",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/prompt_resolver.py",
            },
          ];

          var vrxMethods = [
            {
              id: "meth-run-voice-rx",
              label: "run_voice_rx_evaluation",
              type: "method",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/voice_rx_runner.py",
            },
            {
              id: "meth-save-api-log",
              label: "_save_api_log",
              type: "method",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/voice_rx_runner.py",
            },
            {
              id: "meth-update-progress",
              label: "_update_progress",
              type: "method",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/voice_rx_runner.py",
            },
            {
              id: "meth-evaluation-overlay",
              label: "EvaluationOverlay",
              type: "method",
              layer: "frontend",
              feature: "voice-rx-eval",
              fullPath: "src/features/evals/components/EvaluationOverlay.tsx",
            },
            {
              id: "meth-use-ai-eval",
              label: "useAIEvaluation",
              type: "method",
              layer: "frontend",
              feature: "voice-rx-eval",
              fullPath: "src/features/evals/hooks/useAIEvaluation.ts",
            },
            {
              id: "meth-parse-transcript",
              label: "parse_transcript_response",
              type: "method",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/response_parser.py",
            },
            {
              id: "meth-parse-critique",
              label: "parse_critique_response",
              type: "method",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/response_parser.py",
            },
            {
              id: "meth-parse-api-critique",
              label: "parse_api_critique_response",
              type: "method",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/response_parser.py",
            },
            {
              id: "meth-resolve-prompt",
              label: "resolve_prompt",
              type: "method",
              layer: "backend",
              feature: "voice-rx-eval",
              fullPath: "backend/app/services/evaluators/prompt_resolver.py",
            },
          ];

          // Batch Evaluation files
          var batchFiles = [
            {
              id: "file-batch-runner",
              label: "batch_runner.py",
              type: "file",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/batch_runner.py",
            },
            {
              id: "file-data-loader",
              label: "data_loader.py",
              type: "file",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/data_loader.py",
            },
            {
              id: "file-intent-evaluator",
              label: "intent_evaluator.py",
              type: "file",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/intent_evaluator.py",
            },
            {
              id: "file-correctness-evaluator",
              label: "correctness_evaluator.py",
              type: "file",
              layer: "backend",
              feature: "batch-eval",
              fullPath:
                "backend/app/services/evaluators/correctness_evaluator.py",
            },
            {
              id: "file-efficiency-evaluator",
              label: "efficiency_evaluator.py",
              type: "file",
              layer: "backend",
              feature: "batch-eval",
              fullPath:
                "backend/app/services/evaluators/efficiency_evaluator.py",
            },
            {
              id: "file-new-batch-overlay",
              label: "NewBatchEvalOverlay.tsx",
              type: "file",
              layer: "frontend",
              feature: "batch-eval",
              fullPath:
                "src/features/evalRuns/components/NewBatchEvalOverlay.tsx",
            },
          ];

          var batchMethods = [
            {
              id: "meth-run-batch",
              label: "run_batch_evaluation",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/batch_runner.py",
            },
            {
              id: "meth-data-loader",
              label: "DataLoader",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/data_loader.py",
            },
            {
              id: "meth-get-thread",
              label: "get_thread",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/data_loader.py",
            },
            {
              id: "meth-get-all-threads",
              label: "get_all_thread_ids",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/data_loader.py",
            },
            {
              id: "meth-intent-eval",
              label: "IntentEvaluator",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/intent_evaluator.py",
            },
            {
              id: "meth-evaluate-thread",
              label: "evaluate_thread",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath: "backend/app/services/evaluators/intent_evaluator.py",
            },
            {
              id: "meth-correctness-eval",
              label: "CorrectnessEvaluator",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath:
                "backend/app/services/evaluators/correctness_evaluator.py",
            },
            {
              id: "meth-efficiency-eval",
              label: "EfficiencyEvaluator",
              type: "method",
              layer: "backend",
              feature: "batch-eval",
              fullPath:
                "backend/app/services/evaluators/efficiency_evaluator.py",
            },
            {
              id: "meth-new-batch-overlay",
              label: "NewBatchEvalOverlay",
              type: "method",
              layer: "frontend",
              feature: "batch-eval",
              fullPath:
                "src/features/evalRuns/components/NewBatchEvalOverlay.tsx",
            },
          ];

          // Adversarial Testing files
          var advFiles = [
            {
              id: "file-adversarial-runner",
              label: "adversarial_runner.py",
              type: "file",
              layer: "backend",
              feature: "adversarial",
              fullPath: "backend/app/services/evaluators/adversarial_runner.py",
            },
            {
              id: "file-adversarial-evaluator",
              label: "adversarial_evaluator.py",
              type: "file",
              layer: "backend",
              feature: "adversarial",
              fullPath:
                "backend/app/services/evaluators/adversarial_evaluator.py",
            },
            {
              id: "file-kaira-client",
              label: "kaira_client.py",
              type: "file",
              layer: "backend",
              feature: "adversarial",
              fullPath: "backend/app/services/evaluators/kaira_client.py",
            },
            {
              id: "file-conversation-agent",
              label: "conversation_agent.py",
              type: "file",
              layer: "backend",
              feature: "adversarial",
              fullPath: "backend/app/services/evaluators/conversation_agent.py",
            },
            {
              id: "file-new-adversarial-overlay",
              label: "NewAdversarialOverlay.tsx",
              type: "file",
              layer: "frontend",
              feature: "adversarial",
              fullPath:
                "src/features/evalRuns/components/NewAdversarialOverlay.tsx",
            },
          ];

          var advMethods = [
            {
              id: "meth-run-adversarial",
              label: "run_adversarial_evaluation",
              type: "method",
              layer: "backend",
              feature: "adversarial",
              fullPath: "backend/app/services/evaluators/adversarial_runner.py",
            },
            {
              id: "meth-adversarial-eval",
              label: "AdversarialEvaluator",
              type: "method",
              layer: "backend",
              feature: "adversarial",
              fullPath:
                "backend/app/services/evaluators/adversarial_evaluator.py",
            },
            {
              id: "meth-generate-test-cases",
              label: "generate_test_cases",
              type: "method",
              layer: "backend",
              feature: "adversarial",
              fullPath:
                "backend/app/services/evaluators/adversarial_evaluator.py",
            },
            {
              id: "meth-evaluate-transcript",
              label: "evaluate_transcript",
              type: "method",
              layer: "backend",
              feature: "adversarial",
              fullPath:
                "backend/app/services/evaluators/adversarial_evaluator.py",
            },
            {
              id: "meth-kaira-client",
              label: "KairaClient",
              type: "method",
              layer: "backend",
              feature: "adversarial",
              fullPath: "backend/app/services/evaluators/kaira_client.py",
            },
            {
              id: "meth-conversation-agent",
              label: "ConversationAgent",
              type: "method",
              layer: "backend",
              feature: "adversarial",
              fullPath: "backend/app/services/evaluators/conversation_agent.py",
            },
            {
              id: "meth-run-conversation",
              label: "run_conversation",
              type: "method",
              layer: "backend",
              feature: "adversarial",
              fullPath: "backend/app/services/evaluators/conversation_agent.py",
            },
            {
              id: "meth-new-adversarial-overlay",
              label: "NewAdversarialOverlay",
              type: "method",
              layer: "frontend",
              feature: "adversarial",
              fullPath:
                "src/features/evalRuns/components/NewAdversarialOverlay.tsx",
            },
          ];

          // Custom Evaluators files
          var customFiles = [
            {
              id: "file-custom-eval-runner",
              label: "custom_evaluator_runner.py",
              type: "file",
              layer: "backend",
              feature: "custom-evaluators",
              fullPath:
                "backend/app/services/evaluators/custom_evaluator_runner.py",
            },
            {
              id: "file-use-evaluator-runner",
              label: "useEvaluatorRunner.ts",
              type: "file",
              layer: "frontend",
              feature: "custom-evaluators",
              fullPath: "src/features/evals/hooks/useEvaluatorRunner.ts",
            },
            {
              id: "file-schema-generator",
              label: "schema_generator.py",
              type: "file",
              layer: "backend",
              feature: "custom-evaluators",
              fullPath: "backend/app/services/evaluators/schema_generator.py",
            },
          ];

          var customMethods = [
            {
              id: "meth-run-custom-eval",
              label: "run_custom_evaluator",
              type: "method",
              layer: "backend",
              feature: "custom-evaluators",
              fullPath:
                "backend/app/services/evaluators/custom_evaluator_runner.py",
            },
            {
              id: "meth-extract-scores",
              label: "_extract_scores",
              type: "method",
              layer: "backend",
              feature: "custom-evaluators",
              fullPath:
                "backend/app/services/evaluators/custom_evaluator_runner.py",
            },
            {
              id: "meth-use-evaluator-runner",
              label: "useEvaluatorRunner",
              type: "method",
              layer: "frontend",
              feature: "custom-evaluators",
              fullPath: "src/features/evals/hooks/useEvaluatorRunner.ts",
            },
            {
              id: "meth-gen-json-schema",
              label: "generate_json_schema",
              type: "method",
              layer: "backend",
              feature: "custom-evaluators",
              fullPath: "backend/app/services/evaluators/schema_generator.py",
            },
          ];

          // Template Variables files
          var templateFiles = [
            {
              id: "file-variable-registry",
              label: "variableRegistry.ts",
              type: "file",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableRegistry.ts",
            },
            {
              id: "file-variable-resolver",
              label: "variableResolver.ts",
              type: "file",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableResolver.ts",
            },
          ];

          var templateMethods = [
            {
              id: "meth-get-available-vars",
              label: "getAvailableVariables",
              type: "method",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableRegistry.ts",
            },
            {
              id: "meth-extract-variables",
              label: "extractVariables",
              type: "method",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableRegistry.ts",
            },
            {
              id: "meth-validate-prompt-vars",
              label: "validatePromptVariables",
              type: "method",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableRegistry.ts",
            },
            {
              id: "meth-resolve-variable",
              label: "resolveVariable",
              type: "method",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableResolver.ts",
            },
            {
              id: "meth-resolve-prompt-tmpl",
              label: "resolvePrompt",
              type: "method",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableResolver.ts",
            },
            {
              id: "meth-resolve-all-vars",
              label: "resolveAllVariables",
              type: "method",
              layer: "frontend",
              feature: "template-vars",
              fullPath: "src/services/templates/variableResolver.ts",
            },
          ];

          // LLM Pipeline files
          var llmFiles = [
            {
              id: "file-llm-base",
              label: "llm_base.py",
              type: "file",
              layer: "backend",
              feature: "llm-pipeline",
              fullPath: "backend/app/services/evaluators/llm_base.py",
            },
            {
              id: "file-llm-pipeline",
              label: "LLMInvocationPipeline.ts",
              type: "file",
              layer: "frontend",
              feature: "llm-pipeline",
              fullPath: "src/services/llm/pipeline/index.ts",
            },
            {
              id: "file-model-discovery",
              label: "modelDiscovery.ts",
              type: "file",
              layer: "frontend",
              feature: "llm-pipeline",
              fullPath: "src/services/llm/modelDiscovery.ts",
            },
          ];

          var llmMethods = [
            {
              id: "meth-base-llm-provider",
              label: "BaseLLMProvider",
              type: "method",
              layer: "backend",
              feature: "llm-pipeline",
              fullPath: "backend/app/services/evaluators/llm_base.py",
            },
            {
              id: "meth-gemini-provider",
              label: "GeminiProvider",
              type: "method",
              layer: "backend",
              feature: "llm-pipeline",
              fullPath: "backend/app/services/evaluators/llm_base.py",
            },
            {
              id: "meth-openai-provider",
              label: "OpenAIProvider",
              type: "method",
              layer: "backend",
              feature: "llm-pipeline",
              fullPath: "backend/app/services/evaluators/llm_base.py",
            },
            {
              id: "meth-logging-wrapper",
              label: "LoggingLLMWrapper",
              type: "method",
              layer: "backend",
              feature: "llm-pipeline",
              fullPath: "backend/app/services/evaluators/llm_base.py",
            },
            {
              id: "meth-create-llm-provider",
              label: "create_llm_provider",
              type: "method",
              layer: "backend",
              feature: "llm-pipeline",
              fullPath: "backend/app/services/evaluators/llm_base.py",
            },
            {
              id: "meth-create-llm-pipeline",
              label: "createLLMPipeline",
              type: "method",
              layer: "frontend",
              feature: "llm-pipeline",
              fullPath: "src/services/llm/pipeline/index.ts",
            },
            {
              id: "meth-discover-models",
              label: "discoverModels",
              type: "method",
              layer: "frontend",
              feature: "llm-pipeline",
              fullPath: "src/services/llm/modelDiscovery.ts",
            },
          ];

          // Settings & Config files
          var settingsFiles = [
            {
              id: "file-settings-helper",
              label: "settings_helper.py",
              type: "file",
              layer: "backend",
              feature: "settings-config",
              fullPath: "backend/app/services/evaluators/settings_helper.py",
            },
            {
              id: "file-llm-settings-store",
              label: "llmSettingsStore.ts",
              type: "file",
              layer: "frontend",
              feature: "settings-config",
              fullPath: "src/stores/llmSettingsStore.ts",
            },
            {
              id: "file-job-worker",
              label: "job_worker.py",
              type: "file",
              layer: "backend",
              feature: "settings-config",
              fullPath: "backend/app/services/job_worker.py",
            },
            {
              id: "file-provider-config-card",
              label: "ProviderConfigCard.tsx",
              type: "file",
              layer: "frontend",
              feature: "settings-config",
              fullPath:
                "src/features/settings/components/ProviderConfigCard.tsx",
            },
          ];

          var settingsMethods = [
            {
              id: "meth-get-llm-settings",
              label: "get_llm_settings_from_db",
              type: "method",
              layer: "backend",
              feature: "settings-config",
              fullPath: "backend/app/services/evaluators/settings_helper.py",
            },
            {
              id: "meth-detect-sa-path",
              label: "_detect_service_account_path",
              type: "method",
              layer: "backend",
              feature: "settings-config",
              fullPath: "backend/app/services/evaluators/settings_helper.py",
            },
            {
              id: "meth-llm-settings-store",
              label: "useLLMSettingsStore",
              type: "method",
              layer: "frontend",
              feature: "settings-config",
              fullPath: "src/stores/llmSettingsStore.ts",
            },
            {
              id: "meth-worker-loop",
              label: "worker_loop",
              type: "method",
              layer: "backend",
              feature: "settings-config",
              fullPath: "backend/app/services/job_worker.py",
            },
            {
              id: "meth-process-job",
              label: "process_job",
              type: "method",
              layer: "backend",
              feature: "settings-config",
              fullPath: "backend/app/services/job_worker.py",
            },
            {
              id: "meth-register-job-handler",
              label: "register_job_handler",
              type: "method",
              layer: "backend",
              feature: "settings-config",
              fullPath: "backend/app/services/job_worker.py",
            },
            {
              id: "meth-provider-config-card",
              label: "ProviderConfigCard",
              type: "method",
              layer: "frontend",
              feature: "settings-config",
              fullPath:
                "src/features/settings/components/ProviderConfigCard.tsx",
            },
          ];

          // Combine all nodes
          var nodes = [].concat(
            featureNodes,
            vrxFiles,
            vrxMethods,
            batchFiles,
            batchMethods,
            advFiles,
            advMethods,
            customFiles,
            customMethods,
            templateFiles,
            templateMethods,
            llmFiles,
            llmMethods,
            settingsFiles,
            settingsMethods,
          );

          // Assign radius based on type
          nodes.forEach(function (n) {
            if (n.type === "feature") n.radius = 24;
            else if (n.type === "file") n.radius = 14;
            else n.radius = 8;
          });

          // -------------------------------------------------------
          // 7b. Define links
          // -------------------------------------------------------
          var links = [];

          // Helper: connect feature to its files, files to their methods
          function connectFeature(featureId, files, methods) {
            files.forEach(function (f) {
              links.push({ source: featureId, target: f.id });
            });
            methods.forEach(function (m) {
              // Find the file this method belongs to (match by fullPath)
              var parentFile = files.find(function (f) {
                return f.fullPath === m.fullPath;
              });
              if (parentFile) {
                links.push({ source: parentFile.id, target: m.id });
              }
            });
          }

          connectFeature("feat-voice-rx-eval", vrxFiles, vrxMethods);
          connectFeature("feat-batch-eval", batchFiles, batchMethods);
          connectFeature("feat-adversarial", advFiles, advMethods);
          connectFeature("feat-custom-evaluators", customFiles, customMethods);
          connectFeature("feat-template-vars", templateFiles, templateMethods);
          connectFeature("feat-llm-pipeline", llmFiles, llmMethods);
          connectFeature(
            "feat-settings-config",
            settingsFiles,
            settingsMethods,
          );

          // -------------------------------------------------------
          // 7c. Color mappings
          // -------------------------------------------------------
          var layerColors = {
            frontend: { file: "#3b82f6", method: "#93c5fd" },
            backend: { file: "#10b981", method: "#6ee7b7" },
            shared: { file: "#8b5cf6", method: "#c4b5fd" },
          };
          var featureColor = "#6366f1";

          function getNodeColor(d) {
            if (d.type === "feature") return featureColor;
            var lc = layerColors[d.layer] || layerColors.shared;
            return d.type === "file" ? lc.file : lc.method;
          }

          function getNodeStroke(d) {
            if (d.type === "feature") return "#4338ca";
            var lc = layerColors[d.layer] || layerColors.shared;
            return d.type === "file" ? lc.file : lc.method;
          }

          // -------------------------------------------------------
          // 7d. Set up SVG
          // -------------------------------------------------------
          var svgEl = document.getElementById("brain-map-svg");
          if (!svgEl) return;

          // Clear any existing content
          svgEl.innerHTML = "";

          var rect = svgEl.getBoundingClientRect();
          var width = rect.width || 900;
          var height = rect.height || 600;

          var svg = d3
            .select(svgEl)
            .attr("viewBox", "0 0 " + width + " " + height)
            .attr("preserveAspectRatio", "xMidYMid meet");

          // Create a container group for zoom/pan
          var g = svg.append("g").attr("class", "brain-map-root");

          // Zoom behavior
          var zoom = d3
            .zoom()
            .scaleExtent([0.2, 4])
            .on("zoom", function (event) {
              g.attr("transform", event.transform);
            });

          svg.call(zoom);

          // Arrow marker for directed links (optional visual)
          svg
            .append("defs")
            .append("marker")
            .attr("id", "arrowhead")
            .attr("viewBox", "-0 -5 10 10")
            .attr("refX", 20)
            .attr("refY", 0)
            .attr("orient", "auto")
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "var(--border)");

          // -------------------------------------------------------
          // 7e. Force simulation
          // -------------------------------------------------------
          var simulation = d3
            .forceSimulation(nodes)
            .force(
              "link",
              d3
                .forceLink(links)
                .id(function (d) {
                  return d.id;
                })
                .distance(function (d) {
                  if (
                    d.source.type === "feature" ||
                    (typeof d.source === "string" &&
                      d.source.startsWith("feat-"))
                  )
                    return 120;
                  if (
                    d.source.type === "file" ||
                    (typeof d.source === "string" &&
                      d.source.startsWith("file-"))
                  )
                    return 60;
                  return 40;
                }),
            )
            .force(
              "charge",
              d3.forceManyBody().strength(function (d) {
                if (d.type === "feature") return -400;
                if (d.type === "file") return -150;
                return -50;
              }),
            )
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force(
              "collision",
              d3.forceCollide().radius(function (d) {
                return d.radius + 5;
              }),
            );

          // -------------------------------------------------------
          // 7f. Draw links
          // -------------------------------------------------------
          var linkGroup = g.append("g").attr("class", "links");
          var link = linkGroup
            .selectAll("line")
            .data(links)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr("stroke", "var(--border)")
            .attr("stroke-opacity", 0.5)
            .attr("stroke-width", function (d) {
              // Thicker lines for feature-to-file
              return typeof d.source === "object" && d.source.type === "feature"
                ? 1.5
                : 1;
            });

          // -------------------------------------------------------
          // 7g. Draw nodes
          // -------------------------------------------------------
          var nodeGroup = g.append("g").attr("class", "nodes");
          var node = nodeGroup
            .selectAll("circle")
            .data(nodes)
            .enter()
            .append("circle")
            .attr("r", function (d) {
              return d.radius;
            })
            .attr("fill", getNodeColor)
            .attr("stroke", getNodeStroke)
            .attr("stroke-width", function (d) {
              return d.type === "feature" ? 3 : 1.5;
            })
            .attr("cursor", "pointer")
            .attr("opacity", 1)
            .call(
              d3
                .drag()
                .on("start", dragStarted)
                .on("drag", dragged)
                .on("end", dragEnded),
            );

          // Hover: enlarge
          node
            .on("mouseenter", function (event, d) {
              d3.select(this)
                .transition()
                .duration(150)
                .attr("r", d.radius * 1.3);
              // Show label for file/method nodes on hover
              labelGroup
                .selectAll("text")
                .filter(function (ld) {
                  return ld.id === d.id;
                })
                .transition()
                .duration(150)
                .attr("opacity", 1);
            })
            .on("mouseleave", function (event, d) {
              d3.select(this).transition().duration(150).attr("r", d.radius);
              // Hide label for non-feature, non-selected nodes
              if (!d._selected) {
                labelGroup
                  .selectAll("text")
                  .filter(function (ld) {
                    return ld.id === d.id && ld.type !== "feature";
                  })
                  .transition()
                  .duration(150)
                  .attr("opacity", 0);
              }
            });

          // -------------------------------------------------------
          // 7h. Draw labels
          // -------------------------------------------------------
          var labelGroup = g.append("g").attr("class", "labels");
          var label = labelGroup
            .selectAll("text")
            .data(nodes)
            .enter()
            .append("text")
            .attr("class", "node-label")
            .attr("text-anchor", "middle")
            .attr("dy", function (d) {
              return -(d.radius + 6);
            })
            .attr("font-size", function (d) {
              if (d.type === "feature") return "13px";
              if (d.type === "file") return "10px";
              return "9px";
            })
            .attr("font-weight", function (d) {
              return d.type === "feature" ? "700" : "500";
            })
            .attr("fill", "var(--text)")
            .attr("opacity", function (d) {
              return d.type === "feature" ? 1 : 0;
            })
            .text(function (d) {
              return d.label;
            });

          // -------------------------------------------------------
          // 7i. Tick function
          // -------------------------------------------------------
          simulation.on("tick", function () {
            link
              .attr("x1", function (d) {
                return d.source.x;
              })
              .attr("y1", function (d) {
                return d.source.y;
              })
              .attr("x2", function (d) {
                return d.target.x;
              })
              .attr("y2", function (d) {
                return d.target.y;
              });

            node
              .attr("cx", function (d) {
                return d.x;
              })
              .attr("cy", function (d) {
                return d.y;
              });

            label
              .attr("x", function (d) {
                return d.x;
              })
              .attr("y", function (d) {
                return d.y;
              });
          });

          // -------------------------------------------------------
          // 7j. Drag handlers
          // -------------------------------------------------------
          function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }

          function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
          }

          function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }

          // -------------------------------------------------------
          // 7k. Feature pill interaction
          // -------------------------------------------------------
          var featurePills = document.querySelectorAll(
            "#feature-pills .filter-pill",
          );
          featurePills.forEach(function (pill) {
            pill.addEventListener("click", function () {
              // Update active state
              featurePills.forEach(function (p) {
                p.classList.remove("active");
              });
              pill.classList.add("active");

              var targetFeature = pill.dataset.feature;

              if (targetFeature === "all") {
                // Reset all nodes to full visibility
                node
                  .transition()
                  .duration(300)
                  .attr("opacity", 1)
                  .attr("r", function (d) {
                    return d.radius;
                  });
                link.transition().duration(300).attr("stroke-opacity", 0.5);
                label
                  .transition()
                  .duration(300)
                  .attr("opacity", function (d) {
                    return d.type === "feature" ? 1 : 0;
                  });
              } else {
                // Highlight matching feature subgraph
                node
                  .transition()
                  .duration(300)
                  .attr("opacity", function (d) {
                    return d.feature === targetFeature ? 1 : 0.1;
                  })
                  .attr("r", function (d) {
                    if (d.feature === targetFeature) return d.radius * 1.15;
                    return d.radius;
                  });

                link
                  .transition()
                  .duration(300)
                  .attr("stroke-opacity", function (d) {
                    var src = d.source.feature || d.source;
                    var tgt = d.target.feature || d.target;
                    return src === targetFeature && tgt === targetFeature
                      ? 0.8
                      : 0.05;
                  });

                label
                  .transition()
                  .duration(300)
                  .attr("opacity", function (d) {
                    return d.feature === targetFeature ? 1 : 0;
                  });
              }
            });
          });

          // -------------------------------------------------------
          // 7l. Layer filter interaction
          // -------------------------------------------------------
          var layerPills = document.querySelectorAll(
            ".filter-pill[data-layer]",
          );
          layerPills.forEach(function (pill) {
            pill.addEventListener("click", function () {
              // Update active state within layer pills only
              layerPills.forEach(function (p) {
                p.classList.remove("active");
              });
              pill.classList.add("active");

              var targetLayer = pill.dataset.layer;

              if (targetLayer === "all") {
                node
                  .transition()
                  .duration(300)
                  .attr("opacity", 1)
                  .attr("r", function (d) {
                    return d.radius;
                  });
                link.transition().duration(300).attr("stroke-opacity", 0.5);
                label
                  .transition()
                  .duration(300)
                  .attr("opacity", function (d) {
                    return d.type === "feature" ? 1 : 0;
                  });
              } else {
                node
                  .transition()
                  .duration(300)
                  .attr("opacity", function (d) {
                    if (d.type === "feature") return 0.6;
                    return d.layer === targetLayer ? 1 : 0.1;
                  })
                  .attr("r", function (d) {
                    if (d.layer === targetLayer && d.type !== "feature")
                      return d.radius * 1.15;
                    return d.radius;
                  });

                link
                  .transition()
                  .duration(300)
                  .attr("stroke-opacity", function (d) {
                    var srcLayer = d.source.layer || "";
                    var tgtLayer = d.target.layer || "";
                    // Show links where at least one end matches the target layer
                    if (srcLayer === targetLayer || tgtLayer === targetLayer)
                      return 0.6;
                    return 0.05;
                  });

                label
                  .transition()
                  .duration(300)
                  .attr("opacity", function (d) {
                    if (d.type === "feature") return 0.6;
                    return d.layer === targetLayer ? 1 : 0;
                  });
              }
            });
          });

          // -------------------------------------------------------
          // 7m. Search bar interaction
          // -------------------------------------------------------
          var searchInput = document.getElementById("brain-search");
          if (searchInput) {
            var searchTimeout = null;
            searchInput.addEventListener("input", function () {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(function () {
                var query = searchInput.value.trim().toLowerCase();

                if (!query) {
                  // Reset to normal
                  node
                    .transition()
                    .duration(200)
                    .attr("opacity", 1)
                    .attr("r", function (d) {
                      return d.radius;
                    });
                  link.transition().duration(200).attr("stroke-opacity", 0.5);
                  label
                    .transition()
                    .duration(200)
                    .attr("opacity", function (d) {
                      return d.type === "feature" ? 1 : 0;
                    });
                  return;
                }

                // Find matching nodes
                var matchingIds = {};
                nodes.forEach(function (n) {
                  if (n.label.toLowerCase().indexOf(query) !== -1) {
                    matchingIds[n.id] = true;
                  }
                });

                var matchCount = Object.keys(matchingIds).length;

                if (matchCount === 0) {
                  // Dim everything slightly to indicate no match
                  node.transition().duration(200).attr("opacity", 0.3);
                  link.transition().duration(200).attr("stroke-opacity", 0.1);
                  label.transition().duration(200).attr("opacity", 0.3);
                  return;
                }

                // Also include parent feature nodes if any child matches
                nodes.forEach(function (n) {
                  if (matchingIds[n.id] && n.feature) {
                    var featureNode = nodes.find(function (fn) {
                      return fn.type === "feature" && fn.feature === n.feature;
                    });
                    if (featureNode) matchingIds[featureNode.id] = true;
                  }
                });

                node
                  .transition()
                  .duration(200)
                  .attr("opacity", function (d) {
                    return matchingIds[d.id] ? 1 : 0.1;
                  })
                  .attr("r", function (d) {
                    return matchingIds[d.id] ? d.radius * 1.3 : d.radius;
                  });

                link
                  .transition()
                  .duration(200)
                  .attr("stroke-opacity", function (d) {
                    var srcMatch = matchingIds[d.source.id];
                    var tgtMatch = matchingIds[d.target.id];
                    return srcMatch && tgtMatch ? 0.8 : 0.05;
                  });

                label
                  .transition()
                  .duration(200)
                  .attr("opacity", function (d) {
                    return matchingIds[d.id] ? 1 : 0;
                  });
              }, 150);
            });
          }

          // -------------------------------------------------------
          // 7n. Click node -> info panel
          // -------------------------------------------------------
          var infoPanel = document.getElementById("brain-info");

          node.on("click", function (event, d) {
            event.stopPropagation();

            // Clear previous selection
            nodes.forEach(function (n) {
              n._selected = false;
            });
            d._selected = true;

            if (!infoPanel) return;

            var html = "";

            if (d.type === "feature") {
              // Show feature name + list of files
              var featureFiles = nodes.filter(function (n) {
                return n.type === "file" && n.feature === d.feature;
              });
              html +=
                '<h3 style="margin:0 0 0.75rem 0; color:var(--accent);">' +
                escapeHtml(d.label) +
                "</h3>";
              html +=
                '<p style="color:var(--text-secondary); margin:0 0 0.75rem 0;">Feature group (' +
                featureFiles.length +
                " files)</p>";
              html += '<ul style="margin:0; padding-left:1.25rem;">';
              featureFiles.forEach(function (f) {
                var layerBadge =
                  '<span style="display:inline-block; padding:0.125rem 0.5rem; border-radius:99px; font-size:0.7rem; font-weight:600; margin-left:0.5rem; background:' +
                  (f.layer === "frontend"
                    ? "#dbeafe; color:#1d4ed8"
                    : f.layer === "backend"
                      ? "#d1fae5; color:#065f46"
                      : "#ede9fe; color:#5b21b6") +
                  ';">' +
                  f.layer +
                  "</span>";
                html +=
                  '<li style="margin-bottom:0.375rem; color:var(--text);"><code>' +
                  escapeHtml(f.label) +
                  "</code>" +
                  layerBadge +
                  '<br/><span style="font-size:0.75rem; color:var(--text-muted);">' +
                  escapeHtml(f.fullPath) +
                  "</span></li>";
              });
              html += "</ul>";
            } else if (d.type === "file") {
              // Show full path + list of methods
              var fileMethods = nodes.filter(function (n) {
                return n.type === "method" && n.fullPath === d.fullPath;
              });
              var layerLabel =
                d.layer.charAt(0).toUpperCase() + d.layer.slice(1);
              html +=
                '<h3 style="margin:0 0 0.5rem 0; color:var(--text);">' +
                escapeHtml(d.label) +
                "</h3>";
              html +=
                "<p style=\"color:var(--text-muted); margin:0 0 0.25rem 0; font-size:0.85rem; font-family:'JetBrains Mono',monospace;\">" +
                escapeHtml(d.fullPath) +
                "</p>";
              html +=
                '<p style="color:var(--text-secondary); margin:0 0 0.75rem 0;">Layer: <strong>' +
                layerLabel +
                "</strong> &mdash; " +
                fileMethods.length +
                " exported methods</p>";
              if (fileMethods.length > 0) {
                html +=
                  '<div style="display:flex; flex-wrap:wrap; gap:0.375rem;">';
                fileMethods.forEach(function (m) {
                  html +=
                    "<span style=\"display:inline-block; padding:0.25rem 0.625rem; border-radius:6px; background:var(--bg-secondary); border:1px solid var(--border); font-size:0.8rem; font-family:'JetBrains Mono',monospace; color:var(--text);\">" +
                    escapeHtml(m.label) +
                    "</span>";
                });
                html += "</div>";
              }
            } else {
              // Method node: show parent file path
              var parentFile = nodes.find(function (n) {
                return n.type === "file" && n.fullPath === d.fullPath;
              });
              html +=
                "<h3 style=\"margin:0 0 0.5rem 0; color:var(--text); font-family:'JetBrains Mono',monospace;\">" +
                escapeHtml(d.label) +
                "</h3>";
              html +=
                '<p style="color:var(--text-secondary); margin:0 0 0.25rem 0;">Method / Export</p>';
              if (parentFile) {
                html +=
                  '<p style="color:var(--text-muted); margin:0; font-size:0.85rem;">Defined in: <code>' +
                  escapeHtml(parentFile.label) +
                  "</code></p>";
                html +=
                  "<p style=\"color:var(--text-muted); margin:0.25rem 0 0 0; font-size:0.8rem; font-family:'JetBrains Mono',monospace;\">" +
                  escapeHtml(d.fullPath) +
                  "</p>";
              }
            }

            infoPanel.innerHTML = html;
          });

          // Click on empty SVG area resets info panel
          svg.on("click", function () {
            nodes.forEach(function (n) {
              n._selected = false;
            });
            if (infoPanel) {
              infoPanel.innerHTML =
                '<p style="color:var(--text-muted)">Click on a node to see details. Use feature pills above to highlight subgraphs.</p>';
            }
          });

          // -------------------------------------------------------
          // 7o. Responsive resize
          // -------------------------------------------------------
          var resizeTimeout = null;
          window.addEventListener("resize", function () {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function () {
              var newRect = svgEl.getBoundingClientRect();
              var newWidth = newRect.width || 900;
              var newHeight = newRect.height || 600;
              svg.attr("viewBox", "0 0 " + newWidth + " " + newHeight);
              simulation.force(
                "center",
                d3.forceCenter(newWidth / 2, newHeight / 2),
              );
              simulation.alpha(0.3).restart();
            }, 200);
          });

          // -------------------------------------------------------
          // 7p. Helper: escape HTML
          // -------------------------------------------------------
          function escapeHtml(str) {
            var div = document.createElement("div");
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
          }
        }

        // =========================================================
        // 8. LUCIDE ICONS INITIALIZATION
        // =========================================================
        if (window.lucide) {
          lucide.createIcons();
        }
      })();
    </script>
  </body>
</html>
