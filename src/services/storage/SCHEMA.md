# AI Evals Platform - Storage Schema

## Database: ai-evals-platform (Dexie.js)

### Overview
Single IndexedDB database with 3 tables using pattern-based entity discrimination for scalability.

### Tables

#### 1. listings
Stores evaluation records with metadata.

**Schema:**
- `id` (string, PK) - UUID
- `appId` (string, indexed) - 'voice-rx' | 'kaira-bot'
- `updatedAt` (Date, indexed) - For chronological sorting
- Other fields per Listing type

**Indexes:** `id`, `appId`, `updatedAt`

**Usage:** Primary data storage for evaluations, both AI-generated and human-performed.

---

#### 2. files
Binary blob storage for audio and transcript files.

**Schema:**
- `id` (string, PK) - UUID
- `data` (Blob) - File binary content
- `createdAt` (Date) - Upload timestamp

**Indexes:** `id`

**Note:** Blobs are stored directly, not base64 encoded, for optimal performance.

---

#### 3. entities
Universal storage for settings, prompts, schemas, and chat data. Uses type discrimination pattern.

**Schema:**
- `id` (number, PK, auto-increment) - Auto-generated by Dexie
- `appId` (string | null, indexed) - App scope (null = global)
- `type` (string, indexed) - Entity type discriminator
- `key` (string) - Context-dependent identifier
- `version` (number | null) - Version number (prompts/schemas only)
- `data` (object) - Flexible JSON payload

**Indexes:** `id`, `appId`, `type`

**Entity Types:**

##### type: 'setting'
Global or app-specific configuration settings.

**Structure:**
```json
{
  "id": 1,
  "appId": null,  // null = global, "voice-rx" = app-specific
  "type": "setting",
  "key": "voice-rx-settings",
  "version": null,
  "data": { "value": "{...serialized settings...}" }
}
```

**Query:** Filter by `type='setting'`, then `appId` and `key` in JavaScript.

**Used by:** `settingsStore.ts` via custom Zustand storage backend

---

##### type: 'prompt'
LLM prompt templates with version history.

**Structure:**
```json
{
  "id": 10,
  "appId": "voice-rx",
  "type": "prompt",
  "key": "transcription",  // promptType
  "version": 3,
  "data": {
    "name": "Transcription Prompt v3",
    "prompt": "You are an expert...",
    "description": "...",
    "isDefault": true,
    "createdAt": "2026-02-02T12:00:00Z",
    "updatedAt": "2026-02-02T12:00:00Z"
  }
}
```

**Query:** Filter by `type='prompt'` and `appId`, then filter/sort by `key` and `version` in JavaScript.

**Used by:** `promptsRepository.ts`

---

##### type: 'schema'
JSON schemas for structured LLM output validation.

**Structure:**
```json
{
  "id": 11,
  "appId": "voice-rx",
  "type": "schema",
  "key": "evaluation",  // promptType
  "version": 2,
  "data": {
    "name": "Evaluation Schema v2",
    "schema": { "type": "object", "properties": {...} },
    "description": "...",
    "isDefault": true,
    "createdAt": "2026-02-02T12:00:00Z",
    "updatedAt": "2026-02-02T12:00:00Z"
  }
}
```

**Query:** Same pattern as prompts.

**Used by:** `schemasRepository.ts`

---

##### type: 'chatSession'
Kaira Bot conversation sessions.

**Structure:**
```json
{
  "id": 20,
  "appId": "kaira-bot",
  "type": "chatSession",
  "key": "<sessionId>",  // UUID
  "version": null,
  "data": {
    "id": "<sessionId>",
    "appId": "kaira-bot",
    "userId": "<userId>",
    "title": "Health consultation",
    "createdAt": "2026-02-02T12:00:00Z",
    "updatedAt": "2026-02-02T12:00:00Z"
  }
}
```

**Query:** Filter by `type='chatSession'` and `appId='kaira-bot'`.

**Used by:** `chatSessionsRepository` in `chatRepository.ts`

---

##### type: 'chatMessage'
Individual messages within Kaira Bot sessions.

**Structure:**
```json
{
  "id": 21,
  "appId": null,
  "type": "chatMessage",
  "key": "<sessionId>",  // Parent session ID
  "version": null,
  "data": {
    "id": "<messageId>",
    "sessionId": "<sessionId>",
    "role": "user",
    "content": "What are symptoms of flu?",
    "timestamp": "2026-02-02T12:00:00Z"
  }
}
```

**Query:** Filter by `type='chatMessage'` and `key=sessionId`.

**Used by:** `chatMessagesRepository` in `chatRepository.ts`

---

## Design Principles

1. **Simple indexes only** - No compound indexes like `[appId+type]`. Dexie handles single-field indexed queries efficiently.

2. **Filter in JavaScript** - Dexie performs indexed lookups, then additional filtering happens in JavaScript. This is faster than no index at all.

3. **Type discrimination** - Single `entities` table for multiple entity types. Scalable and maintainable pattern.

4. **Version history** - Prompts and schemas maintain version history for rollback capability.

5. **Flexible data field** - `data` is flexible JSON, allowing each entity type to store its specific structure without schema migrations.

6. **App isolation** - `appId` field isolates data between voice-rx and kaira-bot applications.

---

## Migration History

- **v1** (2026-02-02): Initial consolidated schema
  - Migrated from `voice-rx-evaluator-v2` database
  - Consolidated 8 tables â†’ 3 tables
  - Introduced entities table pattern
  - Removed dedicated settings, prompts, schemas, chat tables

---

## Query Patterns

### Get all prompts for an app
```typescript
const entities = await db.entities
  .where('type').equals('prompt')
  .filter(e => e.appId === 'voice-rx')
  .toArray();
```

### Get specific schema version
```typescript
const entities = await db.entities
  .where('type').equals('schema')
  .filter(e => e.appId === appId && e.key === 'evaluation' && e.version === 2)
  .toArray();
```

### Get all messages in a session
```typescript
const entities = await db.entities
  .where('type').equals('chatMessage')
  .filter(e => e.key === sessionId)
  .toArray();
```

---

## Storage Utilities

### Helper Functions (db.ts)

- `getEntity(type, appId, key)` - Get single entity by filters
- `getEntities(type, appId, keyFilter?)` - Get multiple entities with optional key filter
- `saveEntity(entity)` - Create or update entity
- `deleteEntity(id)` - Delete entity by ID
- `getStorageUsage()` - Monitor IndexedDB quota usage

### Repositories

- `listingsRepository` - CRUD operations for evaluation listings
- `filesRepository` - Binary file storage operations
- `promptsRepository` - Prompt version management
- `schemasRepository` - Schema version management
- `chatSessionsRepository` - Chat session management
- `chatMessagesRepository` - Chat message management

---

## Performance Notes

- IndexedDB is async - all operations return Promises
- Indexed queries are O(log n) via B-tree
- JavaScript filtering is O(n) but acceptable for typical dataset sizes
- Blobs stored separately in `files` table to avoid entity table bloat
- Version history for prompts/schemas enables quick rollback without data migration
